<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë”¸ê¹ â€” UI ìŠ¤ì¼ˆë ˆí†¤ ë¯¸ë¦¬ë³´ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  <style>
    .brand-primary { background-color: #2d5bff; }
    .brand-primary:hover { background-color: #1c46e8; }
    .shadow-soft { box-shadow: 0 1px 2px rgba(16,24,40,.06), 0 1px 3px rgba(16,24,40,.10); }
    .card { border:1px solid #e6e8ef; }

    /* Math and content styling */
    .problem-content { line-height: 1.6; }
    .problem-content table {
      border-collapse: collapse;
      margin: 10px 0;
      border: 1px solid #ddd;
    }
    .problem-content th, .problem-content td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: center;
    }
    .problem-content th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    .problem-content img {
      max-width: 100%;
      height: auto;
      margin: 10px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-slate-50">
  <!-- Header -->
  <header class="border-b border-slate-200 bg-white">
    <div class="mx-auto max-w-6xl px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="grid h-8 w-8 place-items-center rounded-lg bg-slate-900 text-sm font-bold text-white">ë”¸</div>
          <div class="text-lg font-bold">ë”¸ê¹</div>
        </div>
        <nav class="ml-8 flex gap-1">
          <button id="tabBuilderBtn" class="rounded-xl px-4 py-2 text-sm font-semibold bg-slate-900 text-white">ì‹œí—˜ì§€ ì œì‘</button>
          <button id="tabFilesBtn" class="rounded-xl px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100">íŒŒì¼ ê´€ë¦¬</button>
        </nav>
      </div>
    </div>
  </header>

  <!-- Builder Tab -->
  <main id="builder" class="mx-auto grid max-w-6xl grid-cols-12 gap-6 px-6 py-8">
    <!-- Left -->
    <section class="col-span-8">
      <h1 class="mb-2 text-3xl font-extrabold">ì‹œí—˜ì§€ ì œì‘</h1>
      <p class="mb-6 text-slate-600">ë¬¸ì œë¥¼ ì„ íƒí•˜ì—¬ ë§ì¶¤í˜• ì‹œí—˜ì§€ë¥¼ ë§Œë“œì„¸ìš”</p>

      <div class="rounded-3xl border border-slate-200 bg-white p-4">
        <div class="mb-4 flex items-center justify-between px-2">
          <h2 class="text-xl font-bold">ë¬¸ì œ ì„ íƒ</h2>
          <div class="flex items-center gap-3">
            <div class="relative inline-block">
              <select class="appearance-none rounded-xl border border-slate-300 bg-white px-4 py-2 pr-9 text-sm text-slate-700 shadow-sm outline-none transition hover:border-slate-400 focus:border-blue-500">
                <option>ì „ì²´</option><option>ì¤‘í•™</option><option>ê³ ë“±</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">â–¼</div>
            </div>
            <span class="text-sm text-slate-600" id="problemCount">ì´ 0ê°œ ë¬¸ì œ</span>
          </div>
        </div>

        <!-- Problems List -->
        <div id="problemsList" class="space-y-4 max-h-96 overflow-y-auto">
          <div class="text-center py-8 text-slate-500">
            <p>íŒŒì¼ ê´€ë¦¬ íƒ­ì—ì„œ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë¬¸ì œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Right -->
    <section class="col-span-4">
      <h2 class="mb-4 text-xl font-bold">ì„ íƒëœ ë¬¸ì œ</h2>
      <div class="rounded-3xl border border-slate-200 bg-white p-4">
        <div id="selectedProblems" class="space-y-2">
          <p class="text-sm text-slate-500">ì„ íƒëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <button class="mt-4 w-full rounded-xl brand-primary py-3 text-sm font-semibold text-white shadow-soft">ì‹œí—˜ì§€ ìƒì„±</button>
      </div>
    </section>
  </main>

  <!-- Files Tab -->
  <main id="files" class="mx-auto max-w-6xl px-6 py-8 hidden">
    <h1 class="mb-2 text-3xl font-extrabold">íŒŒì¼ ê´€ë¦¬</h1>
    <p class="mb-6 text-slate-600">ìˆ˜í•™ ë¬¸ì œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ì •ë¦¬í•˜ì„¸ìš”</p>

    <section class="rounded-3xl border border-dashed border-slate-300 bg-white p-6">
      <div class="grid grid-cols-12 gap-8">
        <div class="col-span-6 flex flex-col justify-center rounded-2xl border border-dashed border-slate-300 p-10">
          <div class="mx-auto grid h-16 w-16 place-items-center rounded-2xl bg-slate-50 text-slate-500 text-2xl">â¬†ï¸</div>
          <h2 class="mt-6 text-3xl font-extrabold">ìˆ˜í•™ ë¬¸ì œ íŒŒì¼ ì—…ë¡œë“œ</h2>
          <p class="mt-3 text-slate-600">PDF í˜•ì‹ì˜ ìˆ˜í•™ ë¬¸ì œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ AIê°€ ìë™ìœ¼ë¡œ ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  ë¶„ë¥˜í•©ë‹ˆë‹¤.</p>
          <p class="mt-4 text-sm text-emerald-600">âœ“ ì§€ì› í˜•ì‹: PDF (ìµœëŒ€ 50MB)</p>
        </div>
        <div class="col-span-6 rounded-2xl border border-dashed border-slate-300 p-10 text-center" id="dropZone">
          <div class="mx-auto grid h-16 w-16 place-items-center rounded-2xl bg-slate-50 text-slate-500 text-2xl">ğŸ“‚</div>
          <p class="mt-6 text-lg font-semibold text-slate-700">íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”</p>
          <div class="mt-5 grid place-items-center">
            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
            <button id="fileSelectBtn" class="inline-flex h-11 items-center justify-center gap-2 rounded-xl brand-primary px-5 text-sm font-semibold text-white shadow-soft">íŒŒì¼ ì„ íƒ</button>
          </div>
          <div id="uploadProgress" class="mt-4 hidden">
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="progressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-sm text-gray-600 mt-2">ì—…ë¡œë“œ ì¤‘...</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Global variables
    let problems = [];
    let selectedProblems = [];

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Page loaded, initializing...');

      // Tab functionality
      const tabBuilderBtn = document.getElementById('tabBuilderBtn');
      const tabFilesBtn = document.getElementById('tabFilesBtn');
      const builderSection = document.getElementById('builder');
      const filesSection = document.getElementById('files');

      function showBuilderTab() {
        tabBuilderBtn.className = 'rounded-xl px-4 py-2 text-sm font-semibold bg-slate-900 text-white';
        tabFilesBtn.className = 'rounded-xl px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100';
        builderSection.classList.remove('hidden');
        filesSection.classList.add('hidden');
      }

      function showFilesTab() {
        tabFilesBtn.className = 'rounded-xl px-4 py-2 text-sm font-semibold bg-slate-900 text-white';
        tabBuilderBtn.className = 'rounded-xl px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100';
        filesSection.classList.remove('hidden');
        builderSection.classList.add('hidden');
      }

      tabBuilderBtn.addEventListener('click', showBuilderTab);
      tabFilesBtn.addEventListener('click', showFilesTab);

      // File upload functionality
      const fileInput = document.getElementById('fileInput');
      const fileSelectBtn = document.getElementById('fileSelectBtn');
      const dropZone = document.getElementById('dropZone');
      const uploadProgress = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');

      // File select button
      fileSelectBtn.addEventListener('click', function() {
        console.log('File select button clicked');
        fileInput.click();
      });

      // File input change
      fileInput.addEventListener('change', function(e) {
        console.log('File selected:', e.target.files);
        handleFiles(e.target.files);
      });

      // Drag and drop
      dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('border-blue-500', 'bg-blue-50');
      });

      dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
      });

      dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        handleFiles(e.dataTransfer.files);
      });

      // Handle file upload
      function handleFiles(files) {
        const pdfFiles = Array.from(files).filter(file => file.type === 'application/pdf');
        if (pdfFiles.length === 0) {
          alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
          return;
        }

        if (pdfFiles.length > 0) {
          uploadFile(pdfFiles[0]);
        }
      }

      // Upload file to server
      function uploadFile(file) {
        const formData = new FormData();
        formData.append('pdf', file);

        uploadProgress.classList.remove('hidden');
        progressText.textContent = `${file.name} ì—…ë¡œë“œ ì¤‘...`;
        progressBar.style.width = '0%';

        // Animate progress bar
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress > 90) progress = 90;
          progressBar.style.width = progress + '%';
        }, 500);

        fetch('/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          clearInterval(progressInterval);
          progressBar.style.width = '100%';

          if (response.ok) {
            progressText.textContent = 'ì²˜ë¦¬ ì™„ë£Œ! ë¬¸ì œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
            return fetch('/api/problems');
          } else {
            throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
          }
        })
        .then(response => response.json())
        .then(data => {
          console.log('Problems loaded:', data);

          if (data.success && data.problems) {
            problems = data.problems;
            renderProblems();

            progressText.textContent = `ì™„ë£Œ! ${data.problems.length}ê°œì˜ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;

            // Switch to builder tab after 2 seconds
            setTimeout(() => {
              uploadProgress.classList.add('hidden');
              showBuilderTab();
            }, 2000);
          } else {
            throw new Error('ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
          }
        })
        .catch(error => {
          console.error('Upload error:', error);
          clearInterval(progressInterval);
          alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
          uploadProgress.classList.add('hidden');
        });
      }

      // Render problems list
      function renderProblems() {
        const problemsList = document.getElementById('problemsList');
        const problemCount = document.getElementById('problemCount');

        problemCount.textContent = `ì´ ${problems.length}ê°œ ë¬¸ì œ`;

        if (problems.length === 0) {
          problemsList.innerHTML = `
            <div class="text-center py-8 text-slate-500">
              <p>íŒŒì¼ ê´€ë¦¬ íƒ­ì—ì„œ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë¬¸ì œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
          `;
          return;
        }

        problemsList.innerHTML = problems.map((problem, index) => {
          const problemText = extractProblemText(problem);

          return `
            <div class="problem-content border border-slate-200 rounded-lg p-4 hover:shadow-sm transition-shadow">
              <div class="flex items-start gap-3">
                <input type="checkbox" id="problem-${index}" class="mt-1" onchange="toggleProblem(${index})">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <label for="problem-${index}" class="font-semibold text-slate-700 cursor-pointer">
                      ë¬¸ì œ ${problem.id || index + 1}
                    </label>
                    ${problem.page ? `<span class="text-xs bg-slate-100 px-2 py-1 rounded">í˜ì´ì§€ ${problem.page}</span>` : ''}
                  </div>
                  <div class="text-slate-600 text-sm">
                    ${problemText}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        // Re-render MathJax
        if (window.MathJax) {
          MathJax.typesetPromise().then(() => {
            console.log('MathJax rendering completed');
          }).catch((err) => console.log('MathJax error: ' + err.message));
        }
      }

      // Extract problem text from different formats
      function extractProblemText(problem) {
        if (problem.content_blocks) {
          // Structured problem
          const textBlocks = problem.content_blocks
            .filter(block => block.type === 'text')
            .map(block => block.content)
            .join(' ');
          return textBlocks.substring(0, 200) + (textBlocks.length > 200 ? '...' : '');
        } else if (problem.content) {
          // Original format
          const content = Array.isArray(problem.content) ? problem.content.join(' ') : problem.content;
          return content.substring(0, 200) + (content.length > 200 ? '...' : '');
        }
        return 'ë‚´ìš© ì—†ìŒ';
      }

      // Load existing problems on page load
      fetch('/api/problems')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.problems && data.problems.length > 0) {
            problems = data.problems;
            renderProblems();
            console.log('Existing problems loaded:', problems.length);
          }
        })
        .catch(error => {
          console.log('No existing problems found');
        });
    });

    // Toggle problem selection
    function toggleProblem(index) {
      const checkbox = document.getElementById(`problem-${index}`);
      const selectedContainer = document.getElementById('selectedProblems');

      if (checkbox.checked) {
        selectedProblems.push(problems[index]);
      } else {
        selectedProblems = selectedProblems.filter(p => p !== problems[index]);
      }

      // Update selected problems display
      if (selectedProblems.length === 0) {
        selectedContainer.innerHTML = '<p class="text-sm text-slate-500">ì„ íƒëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        selectedContainer.innerHTML = selectedProblems.map((problem, idx) => `
          <div class="text-sm p-2 bg-slate-50 rounded">
            ë¬¸ì œ ${problem.id || idx + 1}
          </div>
        `).join('');
      }
    }
  </script>
</body>
</html>