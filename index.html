<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>딸깍 — UI 스켈레톤 미리보기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  <style>
    .brand-primary { background-color: #2d5bff; }
    .brand-primary:hover { background-color: #1c46e8; }
    .shadow-soft { box-shadow: 0 1px 2px rgba(16,24,40,.06), 0 1px 3px rgba(16,24,40,.10); }
    .card { border:1px solid #e6e8ef; }

    /* Math and content styling */
    .problem-content { line-height: 1.6; }
    .problem-content table, .problem-text table {
      border-collapse: collapse;
      margin: 10px 0;
      border: 1px solid #ddd;
      width: 100%;
    }
    .problem-content th, .problem-content td, .problem-text th, .problem-text td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: center;
    }
    .problem-content th, .problem-text th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    .problem-content img, .problem-text img {
      max-width: 100%;
      height: auto;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .problem-text .my-3 {
      margin: 12px 0;
    }
    .problem-text .bg-blue-50 {
      background-color: #eff6ff;
      border-left: 4px solid #3b82f6;
    }
  </style>
</head>
<body class="bg-slate-50">
  <!-- Header -->
  <header class="border-b border-slate-200 bg-white">
    <div class="mx-auto max-w-6xl px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="grid h-8 w-8 place-items-center rounded-lg bg-slate-900 text-sm font-bold text-white">딸</div>
          <div class="text-lg font-bold">딸깍</div>
        </div>
        <nav class="ml-8 flex gap-1">
          <button id="tabBuilderBtn" class="rounded-xl px-4 py-2 text-sm font-semibold bg-slate-900 text-white">시험지 제작</button>
          <button id="tabFilesBtn" class="rounded-xl px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100">파일 관리</button>
        </nav>
      </div>
    </div>
  </header>

  <!-- Builder Tab -->
  <main id="builder" class="mx-auto grid max-w-6xl grid-cols-12 gap-6 px-6 py-8">
    <!-- Left -->
    <section class="col-span-8">
      <h1 class="mb-2 text-3xl font-extrabold">시험지 제작</h1>
      <p class="mb-6 text-slate-600">문제를 선택하여 맞춤형 시험지를 만드세요</p>

      <div class="rounded-3xl border border-slate-200 bg-white p-4">
        <div class="mb-4 flex items-center justify-between px-2">
          <h2 class="text-xl font-bold">문제 선택</h2>
          <div class="flex items-center gap-3">
            <div class="relative inline-block">
              <select class="appearance-none rounded-xl border border-slate-300 bg-white px-4 py-2 pr-9 text-sm text-slate-700 shadow-sm outline-none transition hover:border-slate-400 focus:border-blue-500">
                <option>전체</option><option>중학</option><option>고등</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">▼</div>
            </div>
            <span class="text-sm text-slate-600" id="problemCount">총 0개 문제</span>
          </div>
        </div>

        <!-- Problems List -->
        <div id="problemsList" class="space-y-4 max-h-[600px] overflow-y-auto">
          <div class="text-center py-8 text-slate-500">
            <p>파일 관리 탭에서 PDF 파일을 업로드하면 문제가 여기에 표시됩니다.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Right -->
    <section class="col-span-4">
      <h2 class="mb-4 text-xl font-bold">선택된 문제</h2>
      <div class="rounded-3xl border border-slate-200 bg-white p-4">
        <div id="selectedProblems" class="space-y-2">
          <p class="text-sm text-slate-500">선택된 문제가 없습니다.</p>
        </div>
        <button class="mt-4 w-full rounded-xl brand-primary py-3 text-sm font-semibold text-white shadow-soft">시험지 생성</button>
      </div>
    </section>
  </main>

  <!-- Files Tab -->
  <main id="files" class="mx-auto max-w-6xl px-6 py-8 hidden">
    <h1 class="mb-2 text-3xl font-extrabold">파일 관리</h1>
    <p class="mb-6 text-slate-600">수학 문제 파일을 업로드하고 정리하세요</p>

    <section class="rounded-3xl border border-dashed border-slate-300 bg-white p-6">
      <div class="grid grid-cols-12 gap-8">
        <div class="col-span-6 flex flex-col justify-center rounded-2xl border border-dashed border-slate-300 p-10">
          <div class="mx-auto grid h-16 w-16 place-items-center rounded-2xl bg-slate-50 text-slate-500 text-2xl">⬆️</div>
          <h2 class="mt-6 text-3xl font-extrabold">수학 문제 파일 업로드</h2>
          <p class="mt-3 text-slate-600">PDF 형식의 수학 문제 파일을 업로드하면 AI가 자동으로 문제를 분석하고 분류합니다.</p>
          <p class="mt-4 text-sm text-emerald-600">✓ 지원 형식: PDF (최대 50MB)</p>
        </div>
        <div class="col-span-6 rounded-2xl border border-dashed border-slate-300 p-10 text-center" id="dropZone">
          <div class="mx-auto grid h-16 w-16 place-items-center rounded-2xl bg-slate-50 text-slate-500 text-2xl">📂</div>
          <p class="mt-6 text-lg font-semibold text-slate-700">파일을 여기에 드롭하세요</p>
          <div class="mt-5 grid place-items-center">
            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
            <button id="fileSelectBtn" class="inline-flex h-11 items-center justify-center gap-2 rounded-xl brand-primary px-5 text-sm font-semibold text-white shadow-soft">파일 선택</button>
          </div>
          <div id="uploadProgress" class="mt-4 hidden">
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="progressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-sm text-gray-600 mt-2">업로드 중...</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Global variables
    let problems = [];
    let selectedProblems = [];

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Page loaded, initializing...');

      // Tab functionality
      const tabBuilderBtn = document.getElementById('tabBuilderBtn');
      const tabFilesBtn = document.getElementById('tabFilesBtn');
      const builderSection = document.getElementById('builder');
      const filesSection = document.getElementById('files');

      function showBuilderTab() {
        tabBuilderBtn.className = 'rounded-xl px-4 py-2 text-sm font-semibold bg-slate-900 text-white';
        tabFilesBtn.className = 'rounded-xl px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100';
        builderSection.classList.remove('hidden');
        filesSection.classList.add('hidden');
      }

      function showFilesTab() {
        tabFilesBtn.className = 'rounded-xl px-4 py-2 text-sm font-semibold bg-slate-900 text-white';
        tabBuilderBtn.className = 'rounded-xl px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100';
        filesSection.classList.remove('hidden');
        builderSection.classList.add('hidden');
      }

      tabBuilderBtn.addEventListener('click', showBuilderTab);
      tabFilesBtn.addEventListener('click', showFilesTab);

      // File upload functionality
      const fileInput = document.getElementById('fileInput');
      const fileSelectBtn = document.getElementById('fileSelectBtn');
      const dropZone = document.getElementById('dropZone');
      const uploadProgress = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');

      // File select button
      fileSelectBtn.addEventListener('click', function() {
        console.log('File select button clicked');
        fileInput.click();
      });

      // File input change
      fileInput.addEventListener('change', function(e) {
        console.log('File selected:', e.target.files);
        handleFiles(e.target.files);
      });

      // Drag and drop
      dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('border-blue-500', 'bg-blue-50');
      });

      dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
      });

      dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        handleFiles(e.dataTransfer.files);
      });

      // Handle file upload
      function handleFiles(files) {
        const pdfFiles = Array.from(files).filter(file => file.type === 'application/pdf');
        if (pdfFiles.length === 0) {
          alert('PDF 파일만 업로드 가능합니다.');
          return;
        }

        if (pdfFiles.length > 0) {
          uploadFile(pdfFiles[0]);
        }
      }

      // Upload file to server
      function uploadFile(file) {
        const formData = new FormData();
        formData.append('pdf', file);

        uploadProgress.classList.remove('hidden');
        progressText.textContent = `${file.name} 업로드 중...`;
        progressBar.style.width = '0%';

        // Show detailed progress stages
        const stages = [
          { text: `${file.name} 업로드 중...`, progress: 10 },
          { text: 'PDF 텍스트 변환 중...', progress: 30 },
          { text: '페이지 필터링 중...', progress: 50 },
          { text: '문제 분할 중...', progress: 70 },
          { text: 'AI 구조화 중...', progress: 90 },
          { text: '처리 완료!', progress: 100 }
        ];

        let currentStage = 0;
        const progressInterval = setInterval(() => {
          if (currentStage < stages.length - 1) {
            progressText.textContent = stages[currentStage].text;
            progressBar.style.width = stages[currentStage].progress + '%';
            currentStage++;
          }
        }, 1500);

        fetch('/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          clearInterval(progressInterval);
          progressBar.style.width = '100%';

          console.log('Upload response:', data);

          if (data.success && data.problems) {
            problems = data.problems;
            renderProblems();

            progressText.textContent = `완료! ${data.problems.length}개의 문제가 추가되었습니다.`;

            // Switch to builder tab after 2 seconds
            setTimeout(() => {
              uploadProgress.classList.add('hidden');
              showBuilderTab();
            }, 2000);
          } else {
            throw new Error(data.message || '문제 데이터 로드 실패');
          }
        })
        .catch(error => {
          console.error('Upload error:', error);
          clearInterval(progressInterval);
          alert('파일 업로드에 실패했습니다: ' + error.message);
          uploadProgress.classList.add('hidden');
        });
      }

      // Render problems list
      function renderProblems() {
        const problemsList = document.getElementById('problemsList');
        const problemCount = document.getElementById('problemCount');

        problemCount.textContent = `총 ${problems.length}개 문제`;

        if (problems.length === 0) {
          problemsList.innerHTML = `
            <div class="text-center py-8 text-slate-500">
              <p>파일 관리 탭에서 PDF 파일을 업로드하면 문제가 여기에 표시됩니다.</p>
            </div>
          `;
          return;
        }

        problemsList.innerHTML = problems.map((problem, index) => {
          const problemText = extractProblemText(problem);

          return `
            <div class="problem-content border border-slate-200 rounded-lg p-6 hover:shadow-sm transition-shadow">
              <div class="flex items-start gap-4">
                <input type="checkbox" id="problem-${index}" class="mt-1 w-4 h-4" onchange="toggleProblem(${index})">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-3">
                    <label for="problem-${index}" class="font-semibold text-slate-700 cursor-pointer text-base">
                      문제 ${problem.id || index + 1}
                    </label>
                    ${problem.page ? `<span class="text-xs bg-slate-100 px-2 py-1 rounded">페이지 ${problem.page}</span>` : ''}
                  </div>
                  <div class="text-slate-600 text-sm leading-relaxed problem-text">
                    ${problemText}
                  </div>
                  ${renderProblemOptions(problem)}
                </div>
              </div>
            </div>
          `;
        }).join('');

        // Re-render MathJax
        if (window.MathJax) {
          MathJax.typesetPromise().then(() => {
            console.log('MathJax rendering completed');
          }).catch((err) => console.log('MathJax error: ' + err.message));
        }
      }

      // Extract and render full problem content
      function extractProblemText(problem) {
        if (problem.content_blocks) {
          // Structured problem - render all blocks
          return problem.content_blocks.map(block => {
            if (block.type === 'text') {
              return renderContent(block.content);
            } else if (block.type === 'image') {
              return `<div class="my-3"><img src="${block.content}" alt="문제 이미지" class="max-w-full h-auto rounded border"></div>`;
            } else if (block.type === 'table') {
              return `<div class="my-3">${renderContent(block.content)}</div>`;
            } else if (block.type === 'examples') {
              return `<div class="my-3 p-3 bg-blue-50 rounded border-l-4 border-blue-400">
                        <strong>보기:</strong><br>
                        ${renderContent(block.content)}
                      </div>`;
            }
            return renderContent(block.content);
          }).join('');
        } else if (problem.content) {
          // Original format
          const content = Array.isArray(problem.content) ? problem.content.join('\n') : problem.content;
          return renderContent(content);
        }
        return '내용 없음';
      }

      // Render content with proper HTML formatting
      function renderContent(content) {
        if (!content) return '';

        let processed = content.toString();

        // Convert markdown tables to HTML
        processed = renderMarkdownTable(processed);

        // Process images
        processed = processImagePaths(processed);

        // Keep LaTeX as-is for MathJax
        return processed;
      }

      // Convert markdown tables to HTML
      function renderMarkdownTable(text) {
        const tableRegex = /(?:^|\n)((?:\|[^\n]*\|(?:\n|$))+)/g;

        return text.replace(tableRegex, (match, tableBlock) => {
          const rows = tableBlock.trim().split('\n').map(row => row.trim()).filter(row => row.startsWith('|') && row.endsWith('|'));

          if (rows.length < 2) return match;

          let html = '<table class="border-collapse border border-gray-300 my-3">';

          // Header row
          const headerCells = rows[0].slice(1, -1).split('|').map(cell => cell.trim());
          html += '<thead><tr>';
          headerCells.forEach(cell => {
            html += `<th class="border border-gray-300 px-3 py-2 bg-gray-100 font-semibold">${cell}</th>`;
          });
          html += '</tr></thead>';

          // Skip separator line if exists
          let dataStartIndex = 1;
          if (rows.length > 1 && (rows[1].includes('---') || rows[1].includes('==='))) {
            dataStartIndex = 2;
          }

          // Data rows
          if (dataStartIndex < rows.length) {
            html += '<tbody>';
            for (let i = dataStartIndex; i < rows.length; i++) {
              const dataCells = rows[i].slice(1, -1).split('|').map(cell => cell.trim());
              html += '<tr>';
              dataCells.forEach(cell => {
                html += `<td class="border border-gray-300 px-3 py-2">${cell}</td>`;
              });
              html += '</tr>';
            }
            html += '</tbody>';
          }

          html += '</table>';
          return html;
        });
      }

      // Process image paths
      function processImagePaths(text) {
        return text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, src) => {
          if (!src.startsWith('http') && !src.startsWith('/')) {
            src = `/images/${src}`;
          }
          return `<div class="my-3"><img src="${src}" alt="${alt}" class="max-w-full h-auto rounded border"></div>`;
        });
      }

      // Render problem options (선택지)
      function renderProblemOptions(problem) {
        if (problem.options && problem.options.length > 0) {
          return `
            <div class="mt-4 p-3 bg-gray-50 rounded border">
              <strong class="text-gray-700">선택지:</strong>
              <div class="mt-2 space-y-1">
                ${problem.options.map((option, idx) => `
                  <div class="text-sm">${renderContent(option)}</div>
                `).join('')}
              </div>
            </div>
          `;
        }
        return '';
      }

      // Load existing problems on page load
      fetch('/api/problems')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.problems && data.problems.length > 0) {
            problems = data.problems;
            renderProblems();
            console.log('Existing problems loaded:', problems.length);
          }
        })
        .catch(error => {
          console.log('No existing problems found');
        });
    });

    // Toggle problem selection
    function toggleProblem(index) {
      const checkbox = document.getElementById(`problem-${index}`);
      const selectedContainer = document.getElementById('selectedProblems');

      if (checkbox.checked) {
        selectedProblems.push(problems[index]);
      } else {
        selectedProblems = selectedProblems.filter(p => p !== problems[index]);
      }

      // Update selected problems display
      if (selectedProblems.length === 0) {
        selectedContainer.innerHTML = '<p class="text-sm text-slate-500">선택된 문제가 없습니다.</p>';
      } else {
        selectedContainer.innerHTML = selectedProblems.map((problem, idx) => `
          <div class="text-sm p-2 bg-slate-50 rounded">
            문제 ${problem.id || idx + 1}
          </div>
        `).join('');
      }
    }
  </script>
</body>
</html>