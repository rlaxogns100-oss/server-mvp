# split2.py - ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì¤„ì„ ë…ë¦½ì ìœ¼ë¡œ ì°¾ì•„ì„œ ë¬¸ì œë¥¼ ìë™ ë¶„í• í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
# 
# ì´ ìŠ¤í¬ë¦½íŠ¸ì˜ ì£¼ìš” ëª©ì :
# 1. ì‹œí—˜ ë¬¸ì œ ë¬¸ì„œì—ì„œ ê° ë¬¸í•­ì˜ ì‹œì‘ì ê³¼ ì¢…ë£Œì ì„ ìë™ìœ¼ë¡œ ê°ì§€
# 2. ê°ì§€ëœ ì‹œì‘/ì¢…ë£Œì ì„ ë°”íƒ•ìœ¼ë¡œ ë¬¸ì œë¥¼ ìë™ìœ¼ë¡œ ë¶„í• 
# 3. ë¶„í• ëœ ë¬¸ì œë“¤ì„ JSON í˜•íƒœë¡œ ì €ì¥í•˜ì—¬ í›„ì† ì²˜ë¦¬ ê°€ëŠ¥í•˜ê²Œ í•¨
#
# ì „ì²´ ì²˜ë¦¬ íë¦„:
# 1. ì •ê·œì‹ íŒ¨í„´ë“¤ì„ ì •ì˜í•˜ì—¬ ë¬¸í•­ ì‹œì‘/ì¢…ë£Œ ì‹ í˜¸ë¥¼ ê°ì§€í•  ì¤€ë¹„
# 2. ë¬¸ì„œë¥¼ í•œ ì¤„ì”© ìŠ¤ìº”í•˜ì—¬ ì‹œì‘ ì¤„ë“¤ì„ ì°¾ì•„ ë¦¬ìŠ¤íŠ¸ë¡œ ì €ì¥
# 3. ë¬¸ì„œë¥¼ í•œ ì¤„ì”© ìŠ¤ìº”í•˜ì—¬ ì¢…ë£Œ ì‹ í˜¸ë¥¼ ì°¾ê³ , ì¶”ê°€ ì¡°ê±´ë“¤ì„ í™•ì¸í•˜ì—¬ ì‹¤ì œ ì¢…ë£Œ ì¤„ ê²°ì •
# 4. ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì¤„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì•Œê³ ë¦¬ì¦˜ì„ ì ìš©í•˜ì—¬ ë¬¸ì œë“¤ì„ ë¶„í• 
# 5. ë¶„í• ëœ ë¬¸ì œë“¤ì„ JSON íŒŒì¼ë¡œ ì €ì¥

from pathlib import Path
import re
import sys
import json

# =============================================================================
# ì •ê·œì‹ íŒ¨í„´ ì •ì˜ ì„¹ì…˜
# =============================================================================

# í˜ì´ì§€ ë§ˆí¬ íŒ¨í„´: "<<<PAGE 1>>>", "<<<PAGE 2>>>" ë“±ì˜ í˜•íƒœë¥¼ ê°ì§€
# í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ìº¡ì²˜ ê·¸ë£¹ìœ¼ë¡œ ì¶”ì¶œí•˜ì—¬ í˜„ì¬ í˜ì´ì§€ë¥¼ ì¶”ì í•˜ëŠ” ë° ì‚¬ìš©
PAGE_MARK = re.compile(r"^<<<PAGE\s+(\d+)\s*>>>$")

# ë¬¸í•­ ì‹œì‘ íŒ¨í„´: ë‹¤ì–‘í•œ í˜•íƒœì˜ ë¬¸í•­ ë²ˆí˜¸ë¥¼ ê°ì§€
# - ìˆ«ì + êµ¬ë¶„ì: "1.", "1)", "1ï¼", "1ã€‚", "1ë²ˆ"
# - ì›ë¬¸ì: "â‘ ", "â‘¡", "â‘¢" ë“±
# - ìœ í˜• + ìˆ«ì: "ë‹¨ë‹µí˜•1", "ì„œë‹µí˜•1", "ì£¼ê´€ì‹1"
# - LaTeX ì„¹ì…˜: "\section*{ë‹¨ë‹µí˜• 1}", "\section*{ë‹¨ë‹µí˜• 2}", "\section*{ë‹¨ë‹µí˜• 3)}" ë“±
# - ì˜ë¬¸ + ìˆ«ì: "A32", "B15", "C8" ë“±
QUESTION_RX = re.compile(
    r'^\s*(?:'
    r'(?:\d{1,3})\s*(?:[.)]|[ï¼ã€‚]|ë²ˆ)'   # 1. 1) 1ï¼ 1ã€‚ 1ë²ˆ
    r'|'
    r'[â‘ -â‘³][.)]?'                        # â‘ . â‘ ) â‘  ë“±
    r'|'
    r'(?:ë‹¨ë‹µí˜•|ì„œë‹µí˜•|ì£¼ê´€ì‹)\s*\d+'     # ë‹¨ë‹µí˜•1, ì„œë‹µí˜•1, ì£¼ê´€ì‹1
    r'|'
    r'\\section\*\{ë‹¨ë‹µí˜•\s*\d+[\)}]'     # \section*{ë‹¨ë‹µí˜• 1}, \section*{ë‹¨ë‹µí˜• 2}, \section*{ë‹¨ë‹µí˜• 3)} ë“±
    r'|'
    r'[A-K]\d+'                          # A32, B15, C8 ë“±
    r')'
)

# ë°œë¬¸ ë ì‹ í˜¸ íŒ¨í„´: ë¬¸í•­ì´ ëë‚¬ìŒì„ ë‚˜íƒ€ë‚´ëŠ” ë‹¤ì–‘í•œ í‘œí˜„ë“¤ì„ ê°ì§€
# - ë¬¼ìŒí‘œ: "?", "ï¼Ÿ", "ë¬¼ìŒí‘œ"
# - ëª…ë ¹í˜• í‘œí˜„: "êµ¬í•˜ì‹œì˜¤", "êµ¬í•˜ì—¬ë¼", "êµ¬í•˜ë¼", "í•˜ë¼" ë“± (ë„ì–´ì“°ê¸° í—ˆìš©)
# - ì„¤ëª… ìš”ì²­: "ì„œìˆ í•˜ì‹œì˜¤", "ì„¤ëª…í•˜ì‹œì˜¤" ë“± (ë„ì–´ì“°ê¸° í—ˆìš©)
# - ê³„ì‚° ìš”ì²­: "ê³„ì‚°í•˜ì‹œì˜¤" ë“± (ë„ì–´ì“°ê¸° í—ˆìš©)
# - ì¦ëª… ìš”ì²­: "ì¦ëª…í•˜ì‹œì˜¤" ë“± (ë„ì–´ì“°ê¸° í—ˆìš©)
# - ê¸°íƒ€: "ë³´ì´ì‹œì˜¤", "ì°¾ìœ¼ì‹œì˜¤", "ê³ ë¥´ì‹œì˜¤", "ì„ íƒí•˜ì‹œì˜¤", "ì‘ì„±í•˜ì‹œì˜¤", "ê¸°ì…í•˜ì‹œì˜¤", "ì“°ì‹œì˜¤", "í•˜ì‹œì˜¤"
# - ë ì‹ í˜¸ í›„ ì†Œê´„í˜¸ ì¡°ê±´ë„ í—ˆìš©: "êµ¬í•˜ì‹œì˜¤ (ë‹¨, aëŠ” ìì—°ìˆ˜)"
QUESTION_END_RX = re.compile(
    r'(?:\?|ï¼Ÿ|ë¬¼ìŒí‘œ|'
    # ë„ì–´ì“°ê¸° ë³€í˜•ë“¤ ì¶”ê°€
    r'êµ¬\s*í•˜\s*ì‹œ\s*ì˜¤|êµ¬\s*í•˜\s*ì—¬\s*ë¼|êµ¬\s*í•˜\s*ë¼|í•˜\s*ë¼|'
    r'ì„œ\s*ìˆ \s*í•˜\s*ì‹œ\s*ì˜¤|ì„œ\s*ìˆ \s*í•˜\s*ë¼|ì„¤\s*ëª…\s*í•˜\s*ì‹œ\s*ì˜¤|ì„¤\s*ëª…\s*í•˜\s*ë¼|'
    r'ê³„\s*ì‚°\s*í•˜\s*ì‹œ\s*ì˜¤|ê³„\s*ì‚°\s*í•˜\s*ë¼|ì¦\s*ëª…\s*í•˜\s*ì‹œ\s*ì˜¤|ì¦\s*ëª…\s*í•˜\s*ë¼|'
    r'ë³´\s*ì´\s*ì‹œ\s*ì˜¤|ë³´\s*ì´\s*ë¼|ì°¾\s*ìœ¼\s*ì‹œ\s*ì˜¤|ì°¾\s*ìœ¼\s*ë¼|'
    r'ê³ \s*ë¥´\s*ì‹œ\s*ì˜¤|ê³ \s*ë¥´\s*ë¼|ì„ \s*íƒ\s*í•˜\s*ì‹œ\s*ì˜¤|ì„ \s*íƒ\s*í•˜\s*ë¼|'
    r'ì‘\s*ì„±\s*í•˜\s*ì‹œ\s*ì˜¤|ì‘\s*ì„±\s*í•˜\s*ë¼|ê¸°\s*ì…\s*í•˜\s*ì‹œ\s*ì˜¤|ê¸°\s*ì…\s*í•˜\s*ë¼|'
    r'ì“°\s*ì‹œ\s*ì˜¤|í•˜\s*ì‹œ\s*ì˜¤)'
    r'(?:\s*\([^)]*\))?'  # ë ì‹ í˜¸ í›„ ì†Œê´„í˜¸ ì¡°ê±´ í—ˆìš©
)

# ì´ë¯¸ì§€ ë§í¬ íŒ¨í„´: ë§ˆí¬ë‹¤ìš´ í˜•íƒœì˜ ì´ë¯¸ì§€ ë§í¬ë¥¼ ê°ì§€
# "![alt text](image_url)" í˜•íƒœì˜ ì´ë¯¸ì§€ ë§í¬ëŠ” ì¢…ë£Œ ì‹ í˜¸ë¡œ ì¸ì‹í•˜ì§€ ì•ŠìŒ
IMAGE_LINK_RX = re.compile(r'!\[.*?\]\([^)]+\)')

# ë³´ê¸° íŒ¨í„´: ë¬¸ì œì˜ ë³´ê¸° ì„¹ì…˜ì„ ê°ì§€ (ë„ì–´ì“°ê¸° í—ˆìš©)
# - HTML íƒœê·¸: "<ë³´ê¸°>", "< ë³´ê¸° >" ë“±
# - ëŒ€ê´„í˜¸: "[ë³´ê¸°]", "[ ë³´ê¸° ]" ë“±
# - êº¾ì‡ : "ã€ˆë³´ê¸°ã€‰", "ã€ˆ ë³´ê¸° ã€‰" ë“±
# - ì´ì¤‘ êº¾ì‡ : "<<ë³´ê¸°>>", "<< ë³´ê¸° >>" ë“±
# - LaTeX ì„¹ì…˜: "\section*{ë³´ê¸°}" ë˜ëŠ” "\section*{ë³´ ê¸°}"
VIEW_TOKEN_RX = re.compile(r'(?:'
    # ë³´ê¸° íŒ¨í„´ë“¤ (ë„ì–´ì“°ê¸° í—ˆìš©)
    r'<\s*ë³´\s*ê¸°\s*>|<ë³´ê¸°>|<ë³´ ê¸°>|<\s*ë³´ê¸°\s*>|'
    r'\[\s*ë³´\s*ê¸°\s*\]|\[ë³´ê¸°\]|\[ë³´ ê¸°\]|'
    r'ï¼»\s*ë³´\s*ê¸°\s*ï¼½|ï¼»ë³´ê¸°ï¼½|'
    r'ã€ˆ\s*ë³´\s*ê¸°\s*ã€‰|ã€ˆë³´ê¸°ã€‰|'
    r'<<\s*ë³´\s*ê¸°\s*>>|<<ë³´ê¸°>>|'
    r'ë³´\s*ê¸°\s*>|ë³´ê¸°>|'
    r'<\s*ë³´\s*ê¸°|<ë³´ê¸°|'
    r'^\s*ë³´\s*ê¸°\s*$|'
    r'\\section\*\{[^}]*ë³´\s*ê¸°[^}]*\}|'
    
    # ë³´ê¸° í•­ëª©ë“¤ - ë‹¤ì–‘í•œ í˜•ì‹
    r'^\s*[\(ï¼ˆ]\s*[ã„±-ã…]\s*[\)ï¼‰]|'  # (ã„±), (ã„´), (ã„·) ë“±
    r'^\s*[ã„±-ã…]\s*[\.\ï¼\)ï¼‰]|'      # ã„±. ã„´. ã„·) ë“±
    r'^\s*[ã„±-ã…]\s*$|'               # ì¤„ë°”ê¿ˆ í›„ ã„±, ã„´, ã„· ë“±
    r'^\s*[\(ï¼ˆ]\s*[ê°€-í£]\s*[\)ï¼‰]|'  # (ê°€), (ë‚˜), (ë‹¤) ë“±
    r'^\s*[ê°€-í£]\s*[\.\ï¼\)ï¼‰]|'      # ê°€. ë‚˜. ë‹¤) ë“±
    r'^\s*[\(ï¼ˆ]\s*[A-Z]\s*[\)ï¼‰]|'    # (A), (B), (C) ë“±
    r'^\s*[A-Z]\s*[\.\ï¼\)ï¼‰]|'        # A. B. C) ë“±
    r'^\s*[\(ï¼ˆ]\s*[a-z]\s*[\)ï¼‰]|'    # (a), (b), (c) ë“±
    r'^\s*[a-z]\s*[\.\ï¼\)ï¼‰]|'        # a. b. c) ë“±
    r'^\s*[\(ï¼ˆ]\s*[â…°â…±â…²â…³â…´]\s*[\)ï¼‰]|'  # (â…°), (â…±), (â…²) ë“±
    r'^\s*[â…°â…±â…²â…³â…´]\s*[\.\ï¼\)ï¼‰]|'      # â…°. â…±. â…²) ë“±
    r'^\s*[\(ï¼ˆ]\s*[â‘ â‘¡â‘¢â‘£â‘¤]\s*[\)ï¼‰]|'     # (â‘ ), (â‘¡), (â‘¢) ë“±
    r'^\s*[â‘ â‘¡â‘¢â‘£â‘¤]\s*[\.\ï¼\)ï¼‰]|'         # â‘ . â‘¡. â‘¢) ë“±
    
    # íŠ¹ìˆ˜ ë¬¸ìë“¤
    r'^\s*[á„€-á„’]\s*[\.\ï¼\)ï¼‰]|'      # á„€. á„‚. á„ƒ) ë“± (ììŒ)
    r'^\s*[\u3131-\u314e]\s*[\.\ï¼\)ï¼‰]' # ë‹¤ë¥¸ í•œê¸€ ìëª¨
    r')')

# ì„ ì§€ íŒ¨í„´: ê°ê´€ì‹ ë¬¸ì œì˜ ì„ íƒì§€ë“¤ì„ ê°ì§€
# - ì›ë¬¸ì: â‘ , â‘¡, â‘¢, â‘£, â‘¤
# - ìˆ«ì + êµ¬ë¶„ì: "1.", "2)", "3." ë“± (ì¼ë°˜ ìˆ«ìì™€ ì „ê° ìˆ«ì ëª¨ë‘)
# - ê´„í˜¸ + ìˆ«ì: "(1)", "ï¼ˆ2ï¼‰" ë“±
# - í•œê¸€ ìëª¨: "ã„±.", "ã„´)" ë“±
# - í•œê¸€ ììŒ: "á„€.", "á„‚)" ë“±
CHOICE_LINE_RX = re.compile(
    r'^\s*(?:'
    r'[\u2460-\u2464]'                  # â‘ , â‘¡, â‘¢, â‘£, â‘¤
    r'|[1-5\uff11\uff12\uff13\uff14\uff15]\s*[\.\uff0e\)]'  # 1. 2) 3. ë“±
    r'|[\(ï¼ˆ]\s*[1-5\uff11\uff12\uff13\uff14\uff15]\s*[\)ï¼‰]'  # (1) ï¼ˆ2ï¼‰ ë“±
    r'|[\u1100-\u1112]\s*[\.\uff0e\)]'  # ã„±. ã„´) ë“±
    r'|[\u3131-\u314e]\s*[\.\uff0e\)]'  # á„€. á„‚) ë“±
    r')'
)

# ì¶”ê°€ ì¡°ê±´ íŒ¨í„´: ë¬¸í•­ì— ì¶”ê°€ì ì¸ ì¡°ê±´ì´ ìˆì„ ë•Œ ê°ì§€
# "(ë‹¨, ...)" í˜•íƒœì˜ ì¡°ê±´ë¬¸ì„ ê°ì§€í•˜ì—¬ ì¶”ê°€ ë‚´ìš©ìœ¼ë¡œ ì²˜ë¦¬
ADDITIONAL_CONDITION_RX = re.compile(r'\(\s*ë‹¨\s*[,:]')

# ì„ íƒì§€ ì¤„ íŒ¨í„´ (ë³´ê¸° í•­ëª© ê°ì§€ìš©)
CHOICE_LINE_RX_EXTENDED = re.compile(
    r'^\s*(?:'
    r'[\u2460-\u2464]'                  # â‘ , â‘¡, â‘¢, â‘£, â‘¤
    r'|[1-5\uff11\uff12\uff13\uff14\uff15]\s*[\.\uff0e\)]'  # 1. 2) 3. ë“±
    r'|[\(ï¼ˆ]\s*[1-5\uff11\uff12\uff13\uff14\uff15]\s*[\)ï¼‰]'  # (1) ï¼ˆ2ï¼‰ ë“±
    r'|[\u1100-\u1112]\s*[\.\uff0e\)]'  # ã„±. ã„´) ë“±
    r'|[\u3131-\u314e]\s*[\.\uff0e\)]'  # á„€. á„‚) ë“±
    r')'
)

# í‘œ íŒ¨í„´: LaTeX í‘œ í™˜ê²½ì„ ê°ì§€
# - í‘œ ì‹œì‘/ì¢…ë£Œ: "\begin{tabular}", "\end{tabular}"
# - í‘œ êµ¬ë¶„ì„ : "\hline"
# - í‘œ ì…€: "& ... &" í˜•íƒœ
TABLE_RX = re.compile(r'\\begin\{tabular\}|\\end\{tabular\}|^\s*\\hline|^\s*&.*&')

# ë³´ì´ì§€ ì•ŠëŠ” ë¬¸ì íŒ¨í„´: ìœ ë‹ˆì½”ë“œì˜ ë³´ì´ì§€ ì•ŠëŠ” ë¬¸ìë“¤ì„ ê°ì§€
# í…ìŠ¤íŠ¸ ì •ê·œí™” ì‹œ ì´ëŸ¬í•œ ë¬¸ìë“¤ì„ ì œê±°í•˜ì—¬ íŒ¨í„´ ë§¤ì¹­ì˜ ì •í™•ì„±ì„ ë†’ì„
INVIS_RX = re.compile(r"[\u200B-\u200F\u202A-\u202E\u2060\u2066-\u2069\uFEFF\u00A0]")

# =============================================================================
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì„¹ì…˜
# =============================================================================

def norm_for_detection(line: str) -> str:
    """
    í…ìŠ¤íŠ¸ ì¤„ì„ íŒ¨í„´ ê°ì§€ìš©ìœ¼ë¡œ ì •ê·œí™”í•˜ëŠ” í•¨ìˆ˜
    
    Args:
        line (str): ì •ê·œí™”í•  í…ìŠ¤íŠ¸ ì¤„
        
    Returns:
        str: ì •ê·œí™”ëœ í…ìŠ¤íŠ¸ (ë³´ì´ì§€ ì•ŠëŠ” ë¬¸ì ì œê±°, ì•ë’¤ ê³µë°± ì œê±°)
        
    ì²˜ë¦¬ ê³¼ì •:
    1. ë¹ˆ ì¤„ì¸ ê²½ìš° ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
    2. ë³´ì´ì§€ ì•ŠëŠ” ìœ ë‹ˆì½”ë“œ ë¬¸ìë“¤(ì œë¡œ ë„ˆë¹„ ê³µë°±, ë°©í–¥ì„± ë§ˆì»¤ ë“±) ì œê±°
    3. ì•ë’¤ ê³µë°± ì œê±°
    
    ì´ í•¨ìˆ˜ëŠ” íŒ¨í„´ ë§¤ì¹­ì˜ ì •í™•ì„±ì„ ë†’ì´ê¸° ìœ„í•´ ì‚¬ìš©ë˜ë©°,
    ë¬¸ì„œì—ì„œ ì¶”ì¶œí•œ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì •ê·œí™”í•˜ì—¬ ì¼ê´€ëœ í˜•íƒœë¡œ ë§Œë“­ë‹ˆë‹¤.
    """
    if not line:
        return ""
    # ë³´ì´ì§€ ì•ŠëŠ” ë¬¸ìë“¤ì„ ì œê±°í•˜ì—¬ íŒ¨í„´ ë§¤ì¹­ì˜ ì •í™•ì„± í–¥ìƒ
    line = INVIS_RX.sub("", line)
    # ì•ë’¤ ê³µë°±ì„ ì œê±°í•˜ì—¬ ì •ê·œí™”
    return line.strip()

def safe_preview(text: str, limit: int = 80) -> str:
    """
    í…ìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ë¯¸ë¦¬ë³´ê¸°ìš©ìœ¼ë¡œ ìë¥´ëŠ” í•¨ìˆ˜
    
    Args:
        text (str): ë¯¸ë¦¬ë³´ê¸°í•  í…ìŠ¤íŠ¸
        limit (int): ìµœëŒ€ í‘œì‹œí•  ë¬¸ì ìˆ˜ (ê¸°ë³¸ê°’: 80)
        
    Returns:
        str: ì˜ë¦° í…ìŠ¤íŠ¸ (ì¸ì½”ë”© ì˜¤ë¥˜ ì‹œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
        
    ì²˜ë¦¬ ê³¼ì •:
    1. ë¹ˆ í…ìŠ¤íŠ¸ì¸ ê²½ìš° ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
    2. ì§€ì •ëœ ê¸¸ì´ë§Œí¼ í…ìŠ¤íŠ¸ ìë¥´ê¸°
    3. í˜„ì¬ í„°ë¯¸ë„ ì¸ì½”ë”©ìœ¼ë¡œ ì¸ì½”ë”© ì‹œë„
    4. ì¸ì½”ë”© ì‹¤íŒ¨ ì‹œ ìœ ë‹ˆì½”ë“œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬í•˜ì—¬ ì•ˆì „í•˜ê²Œ í‘œì‹œ
    
    ì´ í•¨ìˆ˜ëŠ” ë””ë²„ê·¸ ì¶œë ¥ì´ë‚˜ ë¡œê·¸ì—ì„œ í•œê¸€ í…ìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ í‘œì‹œí•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
    """
    if not text:
        return ""
    snippet = text[:limit]
    # í˜„ì¬ í„°ë¯¸ë„ì˜ ì¸ì½”ë”©ì„ ê°€ì ¸ì˜¤ê±°ë‚˜ UTF-8ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
    encoding = getattr(sys.stdout, "encoding", None) or "utf-8"
    try:
        # í˜„ì¬ ì¸ì½”ë”©ìœ¼ë¡œ ì¸ì½”ë”© ì‹œë„
        snippet.encode(encoding)
        return snippet
    except UnicodeEncodeError:
        # ì¸ì½”ë”© ì‹¤íŒ¨ ì‹œ ìœ ë‹ˆì½”ë“œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬í•˜ì—¬ ì•ˆì „í•˜ê²Œ í‘œì‹œ
        return snippet.encode("unicode_escape").decode()

# =============================================================================
# í•µì‹¬ ì²˜ë¦¬ í•¨ìˆ˜ ì„¹ì…˜
# =============================================================================

def find_actual_end_line(lines, signal_line, current_page, start_signals, end_signals):
    """
    ì¢…ë£Œ ì‹ í˜¸ ì´í›„ ì¶”ê°€ ì¡°ê±´ë“¤ì„ í™•ì¸í•˜ì—¬ ì‹¤ì œ ì¢…ë£Œ ì¤„ì„ ì°¾ëŠ” í•µì‹¬ í•¨ìˆ˜
    
    ì´ í•¨ìˆ˜ëŠ” ë¬¸í•­ì˜ ì¢…ë£Œ ì‹ í˜¸(ì˜ˆ: "êµ¬í•˜ì‹œì˜¤")ê°€ ë°œê²¬ëœ í›„,
    ê·¸ ë’¤ì— ì˜¤ëŠ” ì¶”ê°€ì ì¸ ë‚´ìš©ë“¤(ì„ ì§€, ë³´ê¸°, í‘œ, ìˆ˜ì‹ ë“±)ì„ í™•ì¸í•˜ì—¬
    ë¬¸í•­ì´ ì‹¤ì œë¡œ ì–´ë””ì„œ ëë‚˜ëŠ”ì§€ ì •í™•íˆ íŒë‹¨í•©ë‹ˆë‹¤.
    
    Args:
        lines (list): ì „ì²´ ë¬¸ì„œì˜ ì¤„ë“¤ (0-based ì¸ë±ìŠ¤)
        signal_line (int): ì¢…ë£Œ ì‹ í˜¸ê°€ ë°œê²¬ëœ ì¤„ ë²ˆí˜¸ (1-based)
        current_page (int): í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
        start_signals (list): ì‹œì‘ ì‹ í˜¸ë“¤ì˜ ë¦¬ìŠ¤íŠ¸
        end_signals (list): ì¢…ë£Œ ì‹ í˜¸ë“¤ì˜ ë¦¬ìŠ¤íŠ¸
        
    Returns:
        int: ì‹¤ì œ ì¢…ë£Œ ì¤„ ë²ˆí˜¸ (0-based ì¸ë±ìŠ¤)
        
    ì²˜ë¦¬ ê³¼ì •:
    1. ì¢…ë£Œ ì‹ í˜¸ ë‹¤ìŒ ì¤„ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ìŠ¤ìº”
    2. íƒìƒ‰ ë²”ìœ„ë¥¼ ë‹¤ìŒ ì‹œì‘/ì¢…ë£Œ ì‹ í˜¸ë¡œ ì œí•œ
    3. í˜ì´ì§€ ë³€ê²½, ë‹¤ìŒ ë¬¸í•­ ì‹œì‘ ë“± ì¤‘ë‹¨ ì¡°ê±´ í™•ì¸
    4. ì¶”ê°€ ë‚´ìš©(ì„ ì§€, ë³´ê¸°, í‘œ, ìˆ˜ì‹ ë“±) ê°ì§€ ë° ì¶”ì 
    5. ì„ ì§€ (5) ë°œê²¬ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
    6. ì¶”ê°€ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì›ë˜ ì¢…ë£Œ ì‹ í˜¸ ì¤„ì„ ì¢…ë£Œì¤„ë¡œ ì‚¬ìš©
    7. ì¶”ê°€ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë§ˆì§€ë§‰ ì¶”ê°€ ë‚´ìš© ì¤„ì„ ì¢…ë£Œì¤„ë¡œ ì‚¬ìš©
    """
    N = len(lines)  # ì „ì²´ ì¤„ ìˆ˜
    j = signal_line  # ì¢…ë£Œ ì‹ í˜¸ ë‹¤ìŒ ì¤„ë¶€í„° ì‹œì‘ (0-based)
    
    # ì¶”ê°€ ë‚´ìš© ì¶”ì ì„ ìœ„í•œ ë³€ìˆ˜ë“¤
    in_additional_content = False  # í˜„ì¬ ì¶”ê°€ ë‚´ìš© ìƒíƒœì— ìˆëŠ”ì§€ ì—¬ë¶€
    last_choice_line_index = None  # ë§ˆì§€ë§‰ ì„ ì§€ ì¤„ ì¸ë±ìŠ¤
    last_subquestion_line_index = None  # ë§ˆì§€ë§‰ ì†Œë¬¸ì œ ì¤„ ì¸ë±ìŠ¤
    last_additional_line_index = None  # ë§ˆì§€ë§‰ ì¶”ê°€ ë‚´ìš© ì¤„ ì¸ë±ìŠ¤

    # íŠ¹ìˆ˜ ì¼€ì´ìŠ¤: í˜ì´ì§€ ì²« ë²ˆì§¸ ì¤„ì—ì„œ ì¢…ë£Œ ì‹ í˜¸ê°€ ë‚˜ì˜¨ ê²½ìš° ì²˜ë¦¬
    if signal_line == 1:
        print(f"    [DEBUG] í˜ì´ì§€ ì²« ë²ˆì§¸ ì¤„ì—ì„œ ì¢…ë£Œ ì‹ í˜¸, í•´ë‹¹ ì¤„ì´ ì¢…ë£Œì¤„: {signal_line}")
        return signal_line - 1  # 0-basedë¡œ ë³€í™˜

    # ë‹¤ìŒ ì‹œì‘ì‹ í˜¸/ì¢…ë£Œì‹ í˜¸ ì°¾ê¸° (íƒìƒ‰ ë²”ìœ„ ì œí•œ)
    next_start_line = None
    next_end_line = None
    
    # í˜„ì¬ ì‹ í˜¸ ì´í›„ì˜ ì‹œì‘ì‹ í˜¸ ì°¾ê¸°
    for signal in start_signals:
        if signal['line'] > signal_line:
            next_start_line = signal['line']
            break
    
    # í˜„ì¬ ì‹ í˜¸ ì´í›„ì˜ ì¢…ë£Œì‹ í˜¸ ì°¾ê¸°
    for signal in end_signals:
        if signal['line'] > signal_line:
            next_end_line = signal['line']
            break
    
    # íƒìƒ‰ ë²”ìœ„ ì œí•œ: min(ë‹¤ìŒ ì‹œì‘ì‹ í˜¸, ë‹¤ìŒ ì¢…ë£Œì‹ í˜¸) ë˜ëŠ” íŒŒì¼ ë
    max_search_line = N
    if next_start_line is not None and next_end_line is not None:
        max_search_line = min(next_start_line, next_end_line)
    elif next_start_line is not None:
        max_search_line = next_start_line
    elif next_end_line is not None:
        max_search_line = next_end_line

    # ì¢…ë£Œ ì‹ í˜¸ ë‹¤ìŒ ì¤„ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ìŠ¤ìº” (íƒìƒ‰ ë²”ìœ„ ì œí•œ)
    while j < max_search_line:
        line = lines[j].rstrip("\n")  # í˜„ì¬ ì¤„ì˜ ê°œí–‰ ë¬¸ì ì œê±°
        det = norm_for_detection(line)  # íŒ¨í„´ ê°ì§€ìš©ìœ¼ë¡œ ì •ê·œí™”

        # ì¤‘ë‹¨ ì¡°ê±´ 1: í˜ì´ì§€ê°€ ë°”ë€Œë©´ ì¦‰ì‹œ ì¤‘ë‹¨
        if PAGE_MARK.match(det):
            print(f"    [DEBUG] í˜ì´ì§€ ë³€ê²½ ê°ì§€, ì¤‘ë‹¨: ì¤„ {j+1}")
            break

        # ì¤‘ë‹¨ ì¡°ê±´ 2: ë‹¤ìŒ ë¬¸í•­ ì‹œì‘ ì‹ í˜¸ ê°ì§€ - ì¦‰ì‹œ ì¤‘ë‹¨
        if QUESTION_RX.match(det):
            print(f"    [DEBUG] ë‹¤ìŒ ë¬¸í•­ ì‹œì‘ ì‹ í˜¸ ê°ì§€, ì¤‘ë‹¨: ì¤„ {j+1}")
            break

        # í˜„ì¬ ì¤„ì—ì„œ ì¶”ê°€ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸
        has_additional_content = False

        # ì¶”ê°€ ë‚´ìš© ê°ì§€ 1: ì†Œê´„í˜¸ ì† ì¶”ê°€ ì¡°ê±´
        # "(ë‹¨, aëŠ” ìì—°ìˆ˜)" ê°™ì€ ì¡°ê±´ë¬¸ì„ ê°ì§€
        if ADDITIONAL_CONDITION_RX.search(det):
            has_additional_content = True
            last_additional_line_index = j
            print(f"    [DEBUG] ì¶”ê°€ ì¡°ê±´ ê°ì§€: ì¤„ {j+1}: {safe_preview(det, 50)}...")

        # ì¶”ê°€ ë‚´ìš© ê°ì§€ 2: ë³´ê¸° í† í°
        # "<ë³´ê¸°>", "[ë³´ê¸°]" ë“±ì˜ ë³´ê¸° ì„¹ì…˜ì„ ê°ì§€
        if VIEW_TOKEN_RX.search(det):
            has_additional_content = True
            in_additional_content = True
            last_additional_line_index = j
            print(f"    [DEBUG] ë³´ê¸° ê°ì§€: ì¤„ {j+1}: {safe_preview(det, 50)}...")

        # ì¶”ê°€ ë‚´ìš© ê°ì§€ 3: ì´ë¯¸ì§€ ë§í¬
        # "![alt text](image_url)" í˜•íƒœì˜ ì´ë¯¸ì§€ë¥¼ ê°ì§€
        if IMAGE_LINK_RX.search(det):
            has_additional_content = True
            in_additional_content = True
            last_additional_line_index = j
            print(f"    [DEBUG] ì´ë¯¸ì§€ ë§í¬ ê°ì§€: ì¤„ {j+1}: {safe_preview(det, 50)}...")

        # ì¶”ê°€ ë‚´ìš© ê°ì§€ 4: ì„ ì§€ ì²˜ë¦¬ ë° ì†Œë¬¸ì œ êµ¬ë¶„
        if CHOICE_LINE_RX.match(det):
            # ì„ ì§€ (5) íŒ¨í„´ì„ ë¨¼ì € í™•ì¸í•˜ì—¬ ë°”ë¡œ ì¢…ë£Œ
            if re.search(r'\(5\)|ï¼ˆ5ï¼‰', det):
                print(f"    [DEBUG] ì„ ì§€ (5) ë°œê²¬, ì¦‰ì‹œ ì¢…ë£Œ: ì¤„ {j+1}")
                return j  # 0-basedë¡œ ë°˜í™˜
            
            if QUESTION_END_RX.search(det):
                # ì†Œë¬¸ì œ: ï¼ˆ1ï¼‰ë‹¤í•­ì‹... í˜•íƒœ (ì¢…ë£Œ ì‹ í˜¸ë„ í¬í•¨)
                # ì†Œë¬¸ì œëŠ” ì˜ˆì™¸ì¡°ê±´ì´ ì•„ë‹ˆë¯€ë¡œ ì¶”ê°€ ë‚´ìš©ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
                print(f"    [DEBUG] ì†Œë¬¸ì œ ê°ì§€ (ì˜ˆì™¸ì¡°ê±´ ì•„ë‹˜): ì¤„ {j+1}: {safe_preview(det, 50)}...")
                # ì†Œë¬¸ì œëŠ” ì˜ˆì™¸ì¡°ê±´ì´ ì•„ë‹ˆë¯€ë¡œ has_additional_contentë¥¼ Trueë¡œ ì„¤ì •í•˜ì§€ ì•ŠìŒ
                # ë”°ë¼ì„œ ì´ì „ ì¢…ë£Œì‹ í˜¸ì—ì„œ ì—¬ê¸°ì„œ ë©ˆì¶¤

            else:
                # ì„ ì§€ ê°œìˆ˜ í™•ì¸ì„ ìœ„í•´ ë‹¤ìŒ ëª‡ ì¤„ì„ ë¯¸ë¦¬ í™•ì¸
                choice_count = 0
                temp_j = j
                while temp_j < min(j + 10, max_search_line):  # ìµœëŒ€ 10ì¤„ê¹Œì§€ í™•ì¸
                    temp_line = lines[temp_j].rstrip("\n")
                    temp_det = norm_for_detection(temp_line)
                    
                    # í˜ì´ì§€ ë³€ê²½ì´ë‚˜ ë‹¤ìŒ ë¬¸í•­ ì‹œì‘ ì‹œ ì¤‘ë‹¨
                    if PAGE_MARK.match(temp_det) or QUESTION_RX.match(temp_det):
                        break
                    
                    # ì„ ì§€ íŒ¨í„´ í™•ì¸: (1), (2), (3), (4), (5) ë˜ëŠ” ï¼ˆ1ï¼‰, ï¼ˆ2ï¼‰, ï¼ˆ3ï¼‰, ï¼ˆ4ï¼‰, ï¼ˆ5ï¼‰
                    if re.match(r'^\s*[ï¼ˆ(]\s*[1-5ï¼‘ï¼’ï¼“ï¼”ï¼•]\s*[ï¼‰)]', temp_det):
                        choice_count += 1
                        if choice_count >= 4:  # 4ê°œ ì´ìƒì´ë©´ ì„ ì§€ë¡œ ê°„ì£¼
                            break
                    
                    temp_j += 1
                
                if choice_count >= 4:
                    # ì¼ë°˜ ì„ ì§€: (1), (2), (3), (4), (5) í˜•íƒœ
                    has_additional_content = True
                    in_additional_content = True
                    last_choice_line_index = j
                    last_additional_line_index = j
                    print(f"    [DEBUG] ì„ ì§€ ê°ì§€ (ì´ {choice_count}ê°œ): ì¤„ {j+1}: {safe_preview(det, 50)}...")
                else:
                    # ì†Œë¬¸ì œ: 3ê°œ ì´í•˜ì˜ ì„ íƒì§€
                    has_additional_content = True
                    in_additional_content = True
                    last_subquestion_line_index = j
                    last_additional_line_index = j
                    print(f"    [DEBUG] ì†Œë¬¸ì œ ê°ì§€ (ì´ {choice_count}ê°œ): ì¤„ {j+1}: {safe_preview(det, 50)}...")

        # ì¶”ê°€ ë‚´ìš© ê°ì§€ 5: í‘œ
        # LaTeX í‘œ í™˜ê²½ì„ ê°ì§€
        if TABLE_RX.match(det):
            has_additional_content = True
            in_additional_content = True
            last_additional_line_index = j
            print(f"    [DEBUG] í‘œ ê°ì§€: ì¤„ {j+1}: {safe_preview(det, 50)}...")

        # ì¶”ê°€ ë‚´ìš© ê°ì§€ 6: ìˆ˜ì‹ í™˜ê²½
        # LaTeX ìˆ˜ì‹ í™˜ê²½ì„ ê°ì§€
        if re.match(r"^(?:\\\[|\\\]|\\begin\{aligned\}|\\end\{aligned\}|&.*&)$", det):
            has_additional_content = True
            in_additional_content = True
            last_additional_line_index = j
            print(f"    [DEBUG] ìˆ˜ì‹ í™˜ê²½ ê°ì§€: ì¤„ {j+1}: {safe_preview(det, 50)}...")

        # ì¶”ê°€ ë‚´ìš©ì´ ê°ì§€ë˜ë©´ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸
        if has_additional_content:
            in_additional_content = True

        # ì¶”ê°€ ë‚´ìš© ìƒíƒœì— ìˆëŠ” ê²½ìš° ê³„ì† ì§„í–‰
        if in_additional_content:
            if det.strip():  # ë¹ˆ ì¤„ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë§ˆì§€ë§‰ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
                last_additional_line_index = j
            print(f"    [DEBUG] ì¶”ê°€ ë‚´ìš© ìƒíƒœ ìœ ì§€, ê³„ì† ì§„í–‰: ì¤„ {j+1}")
            j += 1
            continue

        # ì¶”ê°€ ë‚´ìš©ì´ ì•„ë‹Œ ì¼ë°˜ í…ìŠ¤íŠ¸ê°€ ë‚˜ì˜¤ë©´ ì¢…ë£Œ íŒë‹¨
        if det.strip() and not has_additional_content:
            # ì§€ê¸ˆê¹Œì§€ ëª¨ì€ ì¶”ê°€ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë§ˆì§€ë§‰ ì¶”ê°€ ë‚´ìš© ì¤„ì„ ì¢…ë£Œì¤„ë¡œ ì‚¬ìš©
            candidates = [idx for idx in (last_choice_line_index, last_subquestion_line_index, last_additional_line_index) if idx is not None]
            if candidates:
                print(f"    [DEBUG] ì¶”ê°€ ë‚´ìš© ë°œê²¬, ë§ˆì§€ë§‰ ì¶”ê°€ ë‚´ìš© ì¤„ì„ ì¢…ë£Œì¤„ë¡œ ì‚¬ìš©: {max(candidates) + 1}")
                return max(candidates)
            # ì¶”ê°€ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì›ë˜ ì¢…ë£Œ ì‹ í˜¸ ì¤„ì„ ì¢…ë£Œì¤„ë¡œ ì‚¬ìš©
            print(f"    [DEBUG] ì¶”ê°€ ë‚´ìš© ì—†ìŒ, ì¢…ë£Œ ì‹ í˜¸ ì¤„ì´ ì¢…ë£Œì¤„: {signal_line}")
            return signal_line - 1  # ì¢…ë£Œ ì‹ í˜¸ê°€ ë‚˜ì˜¨ ì¤„ (0-basedë¡œ ë³€í™˜)

        # ë””ë²„ê·¸ ì¶œë ¥: í˜„ì¬ ì¤„ì˜ ìƒíƒœ ì •ë³´
        print(f"    [DEBUG] ì¤„ {j+1}: has_content={has_additional_content}, in_content={in_additional_content}, det='{safe_preview(det, 30)}...'")
        j += 1

    # ë£¨í”„ ì¢…ë£Œ í›„ ìµœì¢… ì²˜ë¦¬
    if last_additional_line_index is not None:
        # ì¶”ê°€ ë‚´ìš©ì´ ìˆì—ˆìœ¼ë©´ ë§ˆì§€ë§‰ ì¶”ê°€ ë‚´ìš© ì¤„ì„ ì¢…ë£Œì¤„ë¡œ ì‚¬ìš©
        print(f"    [DEBUG] í˜ì´ì§€ ë, ë§ˆì§€ë§‰ ì¶”ê°€ ë‚´ìš© ì¤„ì„ ì¢…ë£Œì¤„ë¡œ ì‚¬ìš©: {last_additional_line_index + 1}")
        return last_additional_line_index
    if in_additional_content:
        # ì¶”ê°€ ë‚´ìš© ìƒíƒœì˜€ìœ¼ë©´ í˜„ì¬ ìœ„ì¹˜ì˜ ì´ì „ ì¤„ì„ ì¢…ë£Œì¤„ë¡œ ì‚¬ìš©
        print(f"    [DEBUG] í˜ì´ì§€ ë, ì¶”ê°€ ë‚´ìš© ìƒíƒœì—ì„œ ì¢…ë£Œ: {j}")
        return j - 1
    # ì¶”ê°€ ë‚´ìš©ì´ ì—†ì—ˆìœ¼ë©´ ì›ë˜ ì¢…ë£Œ ì‹ í˜¸ ì¤„ì„ ì¢…ë£Œì¤„ë¡œ ì‚¬ìš©
    print(f"    [DEBUG] í˜ì´ì§€ ë, ì¶”ê°€ ë‚´ìš© ì—†ìŒ, ì¢…ë£Œ ì‹ í˜¸ ì¤„ì´ ì¢…ë£Œì¤„: {signal_line}")
    return signal_line - 1  # ì¢…ë£Œ ì‹ í˜¸ê°€ ë‚˜ì˜¨ ì¤„ (0-basedë¡œ ë³€í™˜)

def find_start_lines():
    """
    ë¬¸ì„œì—ì„œ ë¬¸í•­ì˜ ì‹œì‘ ì¤„ë“¤ì„ ì°¾ëŠ” í•¨ìˆ˜
    
    ì´ í•¨ìˆ˜ëŠ” ì „ì²´ ë¬¸ì„œë¥¼ í•œ ì¤„ì”© ìŠ¤ìº”í•˜ì—¬ ë¬¸í•­ì´ ì‹œì‘ë˜ëŠ” ì§€ì ë“¤ì„ ê°ì§€í•©ë‹ˆë‹¤.
    ë¬¸í•­ ì‹œì‘ ì‹ í˜¸ëŠ” QUESTION_RX ì •ê·œì‹ íŒ¨í„´ìœ¼ë¡œ ì •ì˜ëœ ë‹¤ì–‘í•œ í˜•íƒœì˜
    ë¬¸í•­ ë²ˆí˜¸ë‚˜ ìœ í˜• í‘œì‹œë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
    
    Returns:
        list: ì‹œì‘ ì¤„ ì •ë³´ë“¤ì˜ ë¦¬ìŠ¤íŠ¸
               ê° í•­ëª©ì€ {'page': int, 'line': int, 'content': str, 'normalized': str} í˜•íƒœ
        
    ì²˜ë¦¬ ê³¼ì •:
    1. ì…ë ¥ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    2. íŒŒì¼ì„ UTF-8ë¡œ ì½ì–´ì„œ ì¤„ ë‹¨ìœ„ë¡œ ë¶„í• 
    3. ê° ì¤„ì„ ìˆœì°¨ì ìœ¼ë¡œ ìŠ¤ìº”
    4. í˜ì´ì§€ ë§ˆí¬ ê°ì§€ ì‹œ í˜„ì¬ í˜ì´ì§€ ì—…ë°ì´íŠ¸
    5. ë¬¸í•­ ì‹œì‘ ì‹ í˜¸ ê°ì§€ ì‹œ ì‹œì‘ ì¤„ ì •ë³´ ì €ì¥
    6. ë°œê²¬ëœ ì‹œì‘ ì¤„ë“¤ì˜ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    """
    input_file = Path("output/result.paged.filtered.mmd")
    
    # ì…ë ¥ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    if not input_file.exists():
        print(f"íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {input_file}")
        return []
    
    print("=== ì‹œì‘ ì¤„ ì°¾ê¸° ===")
    
    # íŒŒì¼ì„ UTF-8ë¡œ ì½ì–´ì„œ ì¤„ ë‹¨ìœ„ë¡œ ë¶„í• 
    # errors='ignore' ì˜µì…˜ìœ¼ë¡œ ì¸ì½”ë”© ì˜¤ë¥˜ê°€ ìˆì–´ë„ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
    with open(input_file, 'r', encoding='utf-8', errors='ignore') as f:
        lines = f.readlines()
    
    # ê²°ê³¼ë¥¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸ì™€ ìƒíƒœ ë³€ìˆ˜ë“¤
    start_lines = []  # ë°œê²¬ëœ ì‹œì‘ ì¤„ë“¤ì˜ ì •ë³´ë¥¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
    current_page = 1  # í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ (í˜ì´ì§€ ë§ˆí¬ê°€ ì—†ìœ¼ë©´ 1í˜ì´ì§€ë¡œ ê°€ì •)
    last_recorded_end_line = 0  # ë§ˆì§€ë§‰ìœ¼ë¡œ ê¸°ë¡ëœ ì¢…ë£Œ ì¤„ (í˜„ì¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
    
    # ê° ì¤„ì„ ìˆœì°¨ì ìœ¼ë¡œ ìŠ¤ìº” (1-based ì¸ë±ìŠ¤ë¡œ ì‹œì‘)
    for i, line in enumerate(lines, 1):
        line = line.rstrip('\n')  # ì¤„ ëì˜ ê°œí–‰ ë¬¸ì ì œê±°
        det = norm_for_detection(line)  # íŒ¨í„´ ê°ì§€ìš©ìœ¼ë¡œ ì •ê·œí™”
        
        # í˜ì´ì§€ ë§ˆí¬ í™•ì¸
        # "<<<PAGE 1>>>" í˜•íƒœì˜ í˜ì´ì§€ ë§ˆí¬ë¥¼ ê°ì§€í•˜ì—¬ í˜„ì¬ í˜ì´ì§€ ì—…ë°ì´íŠ¸
        page_match = PAGE_MARK.match(det)
        if page_match:
            current_page = int(page_match.group(1))  # í˜ì´ì§€ ë²ˆí˜¸ ì¶”ì¶œ
            print(f"[í˜ì´ì§€] í˜ì´ì§€ {current_page}ë¡œ ë³€ê²½")
            continue  # í˜ì´ì§€ ë§ˆí¬ëŠ” ì‹œì‘ ì¤„ì´ ì•„ë‹ˆë¯€ë¡œ ë‹¤ìŒ ì¤„ë¡œ
        
        # ë¬¸í•­ ì‹œì‘ ì‹ í˜¸ í™•ì¸
        # QUESTION_RX íŒ¨í„´ì— ë§¤ì¹˜ë˜ëŠ” ì¤„ì„ ë¬¸í•­ ì‹œì‘ìœ¼ë¡œ ì¸ì‹
        if QUESTION_RX.match(det):
            # ì‹œì‘ ì¤„ ì •ë³´ë¥¼ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ì €ì¥
            start_line_info = {
                'page': current_page,  # í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
                'line': i,  # 1-based ì¤„ ë²ˆí˜¸
                'content': safe_preview(line, 100) + ('...' if len(line) > 100 else ''),  # ì›ë³¸ ë‚´ìš© (100ì ì œí•œ)
                'normalized': safe_preview(det, 100) + ('...' if len(det) > 100 else '')  # ì •ê·œí™”ëœ ë‚´ìš© (100ì ì œí•œ)
            }
            start_lines.append(start_line_info)
            print(f"[ì‹œì‘ì¤„] í˜ì´ì§€ {current_page}, ì¤„ {i}: {safe_preview(line, 80)}{'...' if len(line) > 80 else ''}")
    
    print(f"\nì´ {len(start_lines)}ê°œì˜ ì‹œì‘ ì¤„ ë°œê²¬")
    return start_lines

def find_end_lines():
    """
    ë¬¸ì„œì—ì„œ ë¬¸í•­ì˜ ì¢…ë£Œ ì¤„ë“¤ì„ ì°¾ëŠ” í•¨ìˆ˜
    
    ì´ í•¨ìˆ˜ëŠ” ì „ì²´ ë¬¸ì„œë¥¼ í•œ ì¤„ì”© ìŠ¤ìº”í•˜ì—¬ ë¬¸í•­ì´ ëë‚˜ëŠ” ì§€ì ë“¤ì„ ê°ì§€í•©ë‹ˆë‹¤.
    ì¢…ë£Œ ì‹ í˜¸(ì˜ˆ: "êµ¬í•˜ì‹œì˜¤", "?" ë“±)ë¥¼ ì°¾ì€ í›„, find_actual_end_line í•¨ìˆ˜ë¥¼
    í˜¸ì¶œí•˜ì—¬ ì¶”ê°€ì ì¸ ë‚´ìš©ë“¤(ì„ ì§€, ë³´ê¸°, í‘œ ë“±)ì„ ê³ ë ¤í•œ ì‹¤ì œ ì¢…ë£Œ ì¤„ì„ ê²°ì •í•©ë‹ˆë‹¤.
    
    Returns:
        list: ì¢…ë£Œ ì¤„ ì •ë³´ë“¤ì˜ ë¦¬ìŠ¤íŠ¸
               ê° í•­ëª©ì€ {'page': int, 'line': int, 'signal_line': int, 'content': str, 'normalized': str} í˜•íƒœ
        
    ì²˜ë¦¬ ê³¼ì •:
    1. ì…ë ¥ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    2. íŒŒì¼ì„ UTF-8ë¡œ ì½ì–´ì„œ ì¤„ ë‹¨ìœ„ë¡œ ë¶„í• 
    3. ê° ì¤„ì„ ìˆœì°¨ì ìœ¼ë¡œ ìŠ¤ìº”
    4. í˜ì´ì§€ ë§ˆí¬ ê°ì§€ ì‹œ í˜„ì¬ í˜ì´ì§€ ì—…ë°ì´íŠ¸
    5. ì¢…ë£Œ ì‹ í˜¸ ê°ì§€ ì‹œ find_actual_end_line í•¨ìˆ˜ë¡œ ì‹¤ì œ ì¢…ë£Œ ì¤„ ê²°ì •
    6. ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ë¥¼ ìœ„í•´ ì´ë¯¸ ì²˜ë¦¬ëœ ì¢…ë£Œ ì¤„ì€ ê±´ë„ˆë›°ê¸°
    7. ë°œê²¬ëœ ì¢…ë£Œ ì¤„ë“¤ì˜ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    """
    input_file = Path("output/result.paged.filtered.mmd")
    
    # ì…ë ¥ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    if not input_file.exists():
        print(f"íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {input_file}")
        return []
    
    print("\n=== ì¢…ë£Œ ì¤„ ì°¾ê¸° ===")
    
    # íŒŒì¼ì„ UTF-8ë¡œ ì½ì–´ì„œ ì¤„ ë‹¨ìœ„ë¡œ ë¶„í• 
    with open(input_file, 'r', encoding='utf-8', errors='ignore') as f:
        lines = f.readlines()
    
    # ë¨¼ì € ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì‹ í˜¸ë“¤ì„ ìˆ˜ì§‘ (íƒìƒ‰ ë²”ìœ„ ì œí•œì„ ìœ„í•´ í•„ìš”)
    start_signals = []
    end_signals = []
    current_page = 1
    
    # ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì‹ í˜¸ ìˆ˜ì§‘
    for i, line in enumerate(lines, 1):
        line = line.rstrip('\n')
        det = norm_for_detection(line)
        
        # í˜ì´ì§€ ë§ˆí¬ í™•ì¸
        page_match = PAGE_MARK.match(det)
        if page_match:
            current_page = int(page_match.group(1))
            continue
        
        # ë¬¸í•­ ì‹œì‘ ì‹ í˜¸ í™•ì¸
        if QUESTION_RX.match(det):
            start_signals.append({
                'page': current_page,
                'line': i
            })
        
        # ë¬¸í•­ ì¢…ë£Œ ì‹ í˜¸ í™•ì¸ (ì´ë¯¸ì§€ ë§í¬ ì œì™¸)
        if QUESTION_END_RX.search(det) and not IMAGE_LINK_RX.search(det):
            # ì†Œë¬¸ì œì™€ ê°™ì€ ì„ íƒì§€ í˜•íƒœì˜ ë¬¸ì¥ì€ ì¢…ë£Œ ì‹ í˜¸ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
            if not (CHOICE_LINE_RX.match(det) and not QUESTION_RX.match(det)):
                end_signals.append({
                    'page': current_page,
                    'line': i
                })
    
    print(f"ìˆ˜ì§‘ ì™„ë£Œ: ì‹œì‘ì‹ í˜¸ {len(start_signals)}ê°œ, ì¢…ë£Œì‹ í˜¸ {len(end_signals)}ê°œ")
    
    # ê²°ê³¼ë¥¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸ì™€ ìƒíƒœ ë³€ìˆ˜ë“¤
    end_lines = []  # ë°œê²¬ëœ ì¢…ë£Œ ì¤„ë“¤ì˜ ì •ë³´ë¥¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
    current_page = 1  # í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
    last_recorded_end_line = 0  # ë§ˆì§€ë§‰ìœ¼ë¡œ ê¸°ë¡ëœ ì¢…ë£Œ ì¤„ (ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ìš©)
    
    # ê° ì¤„ì„ ìˆœì°¨ì ìœ¼ë¡œ ìŠ¤ìº” (1-based ì¸ë±ìŠ¤ë¡œ ì‹œì‘)
    for i, line in enumerate(lines, 1):
        line = line.rstrip('\n')  # ì¤„ ëì˜ ê°œí–‰ ë¬¸ì ì œê±°
        det = norm_for_detection(line)  # íŒ¨í„´ ê°ì§€ìš©ìœ¼ë¡œ ì •ê·œí™”
        
        # í˜ì´ì§€ ë§ˆí¬ í™•ì¸
        # "<<<PAGE 1>>>" í˜•íƒœì˜ í˜ì´ì§€ ë§ˆí¬ë¥¼ ê°ì§€í•˜ì—¬ í˜„ì¬ í˜ì´ì§€ ì—…ë°ì´íŠ¸
        page_match = PAGE_MARK.match(det)
        if page_match:
            current_page = int(page_match.group(1))  # í˜ì´ì§€ ë²ˆí˜¸ ì¶”ì¶œ
            print(f"[í˜ì´ì§€] í˜ì´ì§€ {current_page}ë¡œ ë³€ê²½")
            continue  # í˜ì´ì§€ ë§ˆí¬ëŠ” ì¢…ë£Œ ì¤„ì´ ì•„ë‹ˆë¯€ë¡œ ë‹¤ìŒ ì¤„ë¡œ
        
        # ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€: ì´ë¯¸ ì²˜ë¦¬ëœ ì¢…ë£Œ ì¤„ë³´ë‹¤ ì´ì „ì¸ ê²½ìš° ê±´ë„ˆë›°ê¸°
        # ì´ëŠ” ê°™ì€ ì¢…ë£Œ ì‹ í˜¸ê°€ ì—¬ëŸ¬ ë²ˆ ê°ì§€ë˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤
        if i <= last_recorded_end_line:
            continue

        # ë¬¸í•­ ì¢…ë£Œ ì‹ í˜¸ í™•ì¸
        # QUESTION_END_RX íŒ¨í„´ì— ë§¤ì¹˜ë˜ê³  ì´ë¯¸ì§€ ë§í¬ê°€ ì•„ë‹Œ ê²½ìš° ì¢…ë£Œ ì‹ í˜¸ë¡œ ì¸ì‹
        if QUESTION_END_RX.search(det) and not IMAGE_LINK_RX.search(det):
            # ì†Œë¬¸ì œì™€ ê°™ì€ ì„ íƒì§€ í˜•íƒœì˜ ë¬¸ì¥ì€ ì¢…ë£Œ ì‹ í˜¸ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
            # ì˜ˆ: "(1) ë‹¤ìŒ ì¤‘ ì˜³ì€ ê²ƒì€?" ê°™ì€ ê²½ìš°ëŠ” ì¢…ë£Œ ì‹ í˜¸ê°€ ì•„ë‹˜
            if CHOICE_LINE_RX.match(det) and not QUESTION_RX.match(det):
                print(f"[ê±´ë„ˆë›°ê¸°] ì†Œë¬¸ì œ í˜•íƒœì˜ ì„ íƒì§€, ì¢…ë£Œ ì‹ í˜¸ë¡œ ì¸ì‹í•˜ì§€ ì•ŠìŒ: ì¤„ {i}")
                continue
                
            print(f"[ì¢…ë£Œì‹ í˜¸] í˜ì´ì§€ {current_page}, ì¤„ {i}: {safe_preview(line, 80)}{'...' if len(line) > 80 else ''}")
            
            # ì¢…ë£Œ ì‹ í˜¸ ë°œê²¬ ì‹œ, ì¶”ê°€ ì¡°ê±´ë“¤ì„ í™•ì¸í•˜ì—¬ ì‹¤ì œ ì¢…ë£Œ ì¤„ ì°¾ê¸°
            # find_actual_end_line í•¨ìˆ˜ê°€ í•µì‹¬ ë¡œì§ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤
            actual_end_line = find_actual_end_line(lines, i, current_page, start_signals, end_signals)
            
            # ì¢…ë£Œ ì¤„ ì •ë³´ë¥¼ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ì €ì¥
            end_line_info = {
                'page': current_page,  # í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
                'line': actual_end_line + 1,  # 0-basedë¥¼ 1-basedë¡œ ë³€í™˜í•œ ì‹¤ì œ ì¢…ë£Œ ì¤„
                'signal_line': i,  # ì›ë˜ ì¢…ë£Œ ì‹ í˜¸ê°€ ë°œê²¬ëœ ì¤„
                'content': safe_preview(lines[actual_end_line], 100).rstrip('\n') + ('...' if len(lines[actual_end_line].rstrip('\n')) > 100 else ''),  # ì‹¤ì œ ì¢…ë£Œ ì¤„ì˜ ë‚´ìš©
                'normalized': safe_preview(norm_for_detection(lines[actual_end_line]), 100) + ('...' if len(norm_for_detection(lines[actual_end_line])) > 100 else '')  # ì •ê·œí™”ëœ ë‚´ìš©
            }
            end_lines.append(end_line_info)
            
            # ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ë¥¼ ìœ„í•´ ë§ˆì§€ë§‰ìœ¼ë¡œ ê¸°ë¡ëœ ì¢…ë£Œ ì¤„ ì—…ë°ì´íŠ¸
            last_recorded_end_line = max(last_recorded_end_line, actual_end_line + 1)
            print(f"[ì¢…ë£Œì¤„] í˜ì´ì§€ {current_page}, ì¤„ {actual_end_line + 1} (ì‹ í˜¸: {i}): {safe_preview(lines[actual_end_line], 80).rstrip()}{'...' if len(lines[actual_end_line].rstrip()) > 80 else ''}")
    
    print(f"\nì´ {len(end_lines)}ê°œì˜ ì¢…ë£Œ ì¤„ ë°œê²¬")
    return end_lines

def calculate_problems_with_algorithm():
    """
    ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì¤„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¬¸ì œ ë¶„í•  ì•Œê³ ë¦¬ì¦˜ì„ ì ìš©í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
    
    ì´ í•¨ìˆ˜ëŠ” ë°œê²¬ëœ ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì¤„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìœ í•œ ìƒíƒœ ê¸°ê³„(Finite State Machine)
    ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ì œë“¤ì„ ìë™ìœ¼ë¡œ ë¶„í• í•©ë‹ˆë‹¤.
    
    ì•Œê³ ë¦¬ì¦˜ì˜ í•µì‹¬ ì•„ì´ë””ì–´:
    - condition=0: ë¬¸ì œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ìƒíƒœ (ì‹œì‘ ì¤„ì´ë‚˜ ì¢…ë£Œ ì¤„ì„ ê¸°ë‹¤ë¦¼)
    - condition=1: ë¬¸ì œê°€ ì‹œì‘ëœ ìƒíƒœ (ì¢…ë£Œ ì¤„ì„ ê¸°ë‹¤ë¦¼)
    
    ìƒíƒœ ì „ì´ ê·œì¹™:
    1. condition=0ì—ì„œ ì‹œì‘ì¤„ ë°œê²¬ â†’ condition=1ë¡œ ì „ì´, ì‹œì‘ì¤„ ê¸°ë¡
    2. condition=0ì—ì„œ ì¢…ë£Œì¤„ ë°œê²¬ â†’ ì¢…ë£Œì¤„ê¹Œì§€ 1ë¬¸ì œë¡œ ë¶„í• , condition=0 ìœ ì§€
    3. condition=1ì—ì„œ ì‹œì‘ì¤„ ë°œê²¬ â†’ ì´ì „ ë¬¸ì œ ì¢…ë£Œ í›„ ìƒˆ ë¬¸ì œ ì‹œì‘, condition=1 ìœ ì§€
    4. condition=1ì—ì„œ ì¢…ë£Œì¤„ ë°œê²¬ â†’ í˜„ì¬ ë¬¸ì œ ì¢…ë£Œ, condition=0ìœ¼ë¡œ ì „ì´
    5. ì‹œì‘ì¤„=ì¢…ë£Œì¤„ì¸ ê²½ìš° â†’ ì¦‰ì‹œ 1ë¬¸ì œë¡œ ë¶„í• , condition=0ìœ¼ë¡œ ì „ì´
    
    Returns:
        list: ë¶„í• ëœ ë¬¸ì œë“¤ì˜ ë¦¬ìŠ¤íŠ¸
               ê° í•­ëª©ì€ (ì‹œì‘ì¤„, ì¢…ë£Œì¤„) íŠœí”Œ í˜•íƒœ (1-based ì¸ë±ìŠ¤)
        
    ì²˜ë¦¬ ê³¼ì •:
    1. ë¬¸ì„œì—ì„œ ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì¤„ ì •ë³´ ìˆ˜ì§‘
    2. ìœ í•œ ìƒíƒœ ê¸°ê³„ ì•Œê³ ë¦¬ì¦˜ ì ìš©
    3. ê° ìƒíƒœ ì „ì´ì— ë”°ë¼ ë¬¸ì œ ë¶„í•  ìˆ˜í–‰
    4. ë¶„í• ëœ ë¬¸ì œë“¤ì˜ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    """
    input_file = Path("output/result.paged.filtered.mmd")
    
    # ì…ë ¥ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    if not input_file.exists():
        print(f"íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {input_file}")
        return []
    
    print("\n=== ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ë¬¸ì œ ë¶„í•  ê³„ì‚° ===")
    
    # íŒŒì¼ì„ UTF-8ë¡œ ì½ì–´ì„œ ì¤„ ë‹¨ìœ„ë¡œ ë¶„í• 
    with open(input_file, 'r', encoding='utf-8', errors='ignore') as f:
        lines = f.readlines()
    
    # ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì¤„ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ë‹¨ê³„
    print("1ë‹¨ê³„: ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì¤„ ì •ë³´ ìˆ˜ì§‘")
    start_lines = []  # ì‹œì‘ ì¤„ ë²ˆí˜¸ë“¤ì„ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸ (1-based)
    end_lines = []    # ì¢…ë£Œ ì¤„ ë²ˆí˜¸ë“¤ì„ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸ (1-based)
    current_page = 1  # í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
    
    # ê° ì¤„ì„ ìˆœì°¨ì ìœ¼ë¡œ ìŠ¤ìº”í•˜ì—¬ ì‹œì‘/ì¢…ë£Œ ì‹ í˜¸ ê°ì§€
    for i, line in enumerate(lines, 1):
        line = line.rstrip('\n')
        det = norm_for_detection(line)
        
        # í˜ì´ì§€ ë§ˆí¬ í™•ì¸ ë° í˜ì´ì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        page_match = PAGE_MARK.match(det)
        if page_match:
            current_page = int(page_match.group(1))
            continue
        
        # ë¬¸í•­ ì‹œì‘ ì‹ í˜¸ í™•ì¸
        if QUESTION_RX.match(det):
            start_lines.append(i)
            print(f"  ì‹œì‘ì¤„ ë°œê²¬: ì¤„ {i}")
        
        # ë¬¸í•­ ì¢…ë£Œ ì‹ í˜¸ í™•ì¸ (ì´ë¯¸ì§€ ë§í¬ ì œì™¸)
        if QUESTION_END_RX.search(det) and not IMAGE_LINK_RX.search(det):
            # ì†Œë¬¸ì œ í˜•íƒœì˜ ì„ íƒì§€ëŠ” ì¢…ë£Œ ì‹ í˜¸ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
            if not (CHOICE_LINE_RX.match(det) and not QUESTION_RX.match(det)):
                # ì¢…ë£Œ ì‹ í˜¸ ë°œê²¬ ì‹œ, ì¶”ê°€ ì¡°ê±´ë“¤ì„ í™•ì¸í•˜ì—¬ ì‹¤ì œ ì¢…ë£Œ ì¤„ ì°¾ê¸°
                # start_signalsì™€ end_signalsë¥¼ ë¹ˆ ë¦¬ìŠ¤íŠ¸ë¡œ ì „ë‹¬ (ì´ ë‹¨ê³„ì—ì„œëŠ” ì•„ì§ ìˆ˜ì§‘ ì¤‘)
                actual_end_line = find_actual_end_line(lines, i, current_page, [], [])
                end_lines.append(actual_end_line + 1)  # 0-basedë¥¼ 1-basedë¡œ ë³€í™˜
                print(f"  ì¢…ë£Œì¤„ ë°œê²¬: ì¤„ {actual_end_line + 1} (ì‹ í˜¸: {i})")
    
    print(f"ìˆ˜ì§‘ ì™„ë£Œ: ì‹œì‘ì¤„ {len(start_lines)}ê°œ, ì¢…ë£Œì¤„ {len(end_lines)}ê°œ")
    
    # ìœ í•œ ìƒíƒœ ê¸°ê³„ ì•Œê³ ë¦¬ì¦˜ ì ìš© ë‹¨ê³„
    print("\n2ë‹¨ê³„: ìœ í•œ ìƒíƒœ ê¸°ê³„ ì•Œê³ ë¦¬ì¦˜ ì ìš©")
    print("ì•Œê³ ë¦¬ì¦˜ ì„¤ëª…:")
    print("- condition=0: ë¬¸ì œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ìƒíƒœ")
    print("- condition=1: ë¬¸ì œê°€ ì‹œì‘ëœ ìƒíƒœ (ì¢…ë£Œì¤„ì„ ê¸°ë‹¤ë¦¼)")
    print("0ë²ˆì§¸ ì¤„ì´ ì¢…ë£Œ ì¤„ì´ì—ˆë‹¤ê³  ê°€ì •í•˜ê³  ì‹œì‘")
    
    # ì•Œê³ ë¦¬ì¦˜ ìƒíƒœ ë³€ìˆ˜ë“¤
    condition = 0  # í˜„ì¬ ìƒíƒœ (0: ëŒ€ê¸°, 1: ë¬¸ì œ ì§„í–‰ ì¤‘)
    last_end_line = 0  # ë§ˆì§€ë§‰ ì¢…ë£Œ ì¤„ ë²ˆí˜¸
    last_start_line = 0  # ë§ˆì§€ë§‰ ì‹œì‘ ì¤„ ë²ˆí˜¸
    problems = []  # ë¶„í• ëœ ë¬¸ì œë“¤ì„ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
    total_lines = len(lines)  # ì „ì²´ ì¤„ ìˆ˜
    
    # ê° ì¤„ì— ëŒ€í•´ ìƒíƒœ ê¸°ê³„ ì•Œê³ ë¦¬ì¦˜ ì ìš©
    for line_num in range(1, total_lines + 1):
        is_start = line_num in start_lines  # í˜„ì¬ ì¤„ì´ ì‹œì‘ì¤„ì¸ì§€ í™•ì¸
        is_end = line_num in end_lines      # í˜„ì¬ ì¤„ì´ ì¢…ë£Œì¤„ì¸ì§€ í™•ì¸
        
        # íŠ¹ìˆ˜ ì¼€ì´ìŠ¤: ì‹œì‘ì¤„ê³¼ ì¢…ë£Œì¤„ì´ ê°™ì€ ì¤„ì¸ ê²½ìš°
        # ì´ëŠ” í•œ ì¤„ë¡œ ì´ë£¨ì–´ì§„ ë¬¸ì œë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤
        if is_start and is_end:
            print(f"  ì¤„ {line_num}: ì‹œì‘ì¤„ê³¼ ì¢…ë£Œì¤„ì´ ê°™ì€ ì¤„, condition=0ìœ¼ë¡œ ë³€ê²½")
            condition = 0
            # í•´ë‹¹ ì¤„ì„ ì¢…ë£Œì¤„ë¡œ ì²˜ë¦¬í•˜ì—¬ 1ë¬¸ì œë¡œ ë¶„í• 
            problem_range = (last_end_line + 1, line_num)
            problems.append(problem_range)
            print(f"  ë¬¸ì œ {len(problems)}: ì¤„ {problem_range[0]}~{problem_range[1]} (ì‹œì‘=ì¢…ë£Œì¤„ {line_num})")
            last_end_line = line_num
            continue
        
        # ìƒíƒœ 0: ë¬¸ì œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ìƒíƒœ
        if condition == 0:
            if is_start:
                # ì‹œì‘ì¤„ì´ ë‚˜ì˜¤ë©´ ìƒíƒœë¥¼ 1ë¡œ ì „ì´í•˜ê³  ì‹œì‘ì¤„ ê¸°ë¡
                print(f"  ì¤„ {line_num}: ì‹œì‘ì¤„ ë°œê²¬, condition=1ë¡œ ì „ì´")
                last_start_line = line_num
                condition = 1
            elif is_end:
                # ì¢…ë£Œì¤„ì´ ë‚˜ì˜¤ë©´ ë§ˆì§€ë§‰ ì¢…ë£Œì¤„+1ë¶€í„° í˜„ì¬ ì¢…ë£Œì¤„ê¹Œì§€ 1ë¬¸ì œë¡œ ë¶„í• 
                print(f"  ì¤„ {line_num}: ì¢…ë£Œì¤„ ë°œê²¬, condition=0 ìœ ì§€")
                problem_range = (last_end_line + 1, line_num)
                problems.append(problem_range)
                print(f"  ë¬¸ì œ {len(problems)}: ì¤„ {problem_range[0]}~{problem_range[1]} (ì¢…ë£Œì¤„ {line_num})")
                last_end_line = line_num
                condition = 0
                
        # ìƒíƒœ 1: ë¬¸ì œê°€ ì‹œì‘ëœ ìƒíƒœ (ì¢…ë£Œì¤„ì„ ê¸°ë‹¤ë¦¼)
        elif condition == 1:
            if is_start:
                # ìƒˆë¡œìš´ ì‹œì‘ì¤„ì´ ë‚˜ì˜¤ë©´ ì´ì „ ë¬¸ì œë¥¼ ì¢…ë£Œí•˜ê³  ìƒˆ ë¬¸ì œ ì‹œì‘
                print(f"  ì¤„ {line_num}: ìƒˆ ì‹œì‘ì¤„ ë°œê²¬, ì´ì „ ë¬¸ì œ ì¢…ë£Œ í›„ ìƒˆ ë¬¸ì œ ì‹œì‘")
                problem_range = (last_start_line, line_num - 1)
                problems.append(problem_range)
                print(f"  ë¬¸ì œ {len(problems)}: ì¤„ {problem_range[0]}~{problem_range[1]} (ìƒˆ ì‹œì‘ì¤„ {line_num} ì „)")
                last_start_line = line_num
                condition = 1  # ìƒˆ ë¬¸ì œê°€ ì‹œì‘ë˜ë¯€ë¡œ ìƒíƒœ 1 ìœ ì§€
            elif is_end:
                # ì¢…ë£Œì¤„ì´ ë‚˜ì˜¤ë©´ í˜„ì¬ ë¬¸ì œë¥¼ ì¢…ë£Œí•˜ê³  ìƒíƒœë¥¼ 0ìœ¼ë¡œ ì „ì´
                print(f"  ì¤„ {line_num}: ì¢…ë£Œì¤„ ë°œê²¬, í˜„ì¬ ë¬¸ì œ ì¢…ë£Œ, condition=0ìœ¼ë¡œ ì „ì´")
                problem_range = (last_start_line, line_num)
                problems.append(problem_range)
                print(f"  ë¬¸ì œ {len(problems)}: ì¤„ {problem_range[0]}~{problem_range[1]} (ì‹œì‘ì¤„ {last_start_line}~ì¢…ë£Œì¤„ {line_num})")
                last_end_line = line_num
                condition = 0
            elif line_num == total_lines:
                # ë§ˆì§€ë§‰ ì¤„ì— ë„ë‹¬í–ˆê³  ì•„ì§ ì¢…ë£Œì¤„ì´ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ì¤„ê¹Œì§€ 1ë¬¸ì œë¡œ ë¶„í• 
                print(f"  ì¤„ {line_num}: ë§ˆì§€ë§‰ ì¤„ ë„ë‹¬, í˜„ì¬ ë¬¸ì œ ì¢…ë£Œ")
                problem_range = (last_start_line, line_num)
                problems.append(problem_range)
                print(f"  ë¬¸ì œ {len(problems)}: ì¤„ {problem_range[0]}~{problem_range[1]} (ë§ˆì§€ë§‰ ì‹œì‘ì¤„ {last_start_line}~ë§ˆì§€ë§‰ì¤„ {line_num})")
                last_end_line = line_num
                condition = 0
    
    # ë§ˆì§€ë§‰ì— ì‹œì‘ì¤„ì´ ë‚¨ì•„ìˆëŠ” ê²½ìš° ì²˜ë¦¬
    # ì´ëŠ” ë¬¸ì„œ ëê¹Œì§€ ì¢…ë£Œì¤„ì´ ì—†ì—ˆë˜ ê²½ìš°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
    if condition == 1:
        print("3ë‹¨ê³„: ë§ˆì§€ë§‰ ì‹œì‘ì¤„ ì²˜ë¦¬")
        problem_range = (last_start_line, total_lines)
        problems.append(problem_range)
        print(f"  ë¬¸ì œ {len(problems)}: ì¤„ {problem_range[0]}~{problem_range[1]} (ë§ˆì§€ë§‰ ì‹œì‘ì¤„ {last_start_line}~ë§ˆì§€ë§‰ì¤„ {total_lines})")
    
    print(f"\nì´ {len(problems)}ê°œ ë¬¸ì œë¡œ ë¶„í• ë¨")
    return problems

def save_problems_to_json(problems):
    """
    ë¶„í• ëœ ë¬¸ì œë“¤ì„ JSON íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
    
    ì´ í•¨ìˆ˜ëŠ” calculate_problems_with_algorithm í•¨ìˆ˜ì—ì„œ ë¶„í• ëœ ë¬¸ì œë“¤ì„
    JSON í˜•íƒœë¡œ ì €ì¥í•˜ì—¬ í›„ì† ì²˜ë¦¬ë‚˜ ë¶„ì„ì´ ê°€ëŠ¥í•˜ë„ë¡ í•©ë‹ˆë‹¤.
    
    Args:
        problems (list): ë¶„í• ëœ ë¬¸ì œë“¤ì˜ ë¦¬ìŠ¤íŠ¸
                         ê° í•­ëª©ì€ (ì‹œì‘ì¤„, ì¢…ë£Œì¤„) íŠœí”Œ í˜•íƒœ
        
    ì²˜ë¦¬ ê³¼ì •:
    1. ì›ë³¸ ë¬¸ì„œë¥¼ ë‹¤ì‹œ ì½ì–´ì„œ ë¬¸ì œ ë‚´ìš© ì¶”ì¶œ
    2. ì‹œì‘/ì¢…ë£Œ ì¤„ ì •ë³´ë¥¼ ë‹¤ì‹œ ìˆ˜ì§‘í•˜ì—¬ í˜ì´ì§€ ì •ë³´ íšë“
    3. ê° ë¬¸ì œì˜ ë‚´ìš©ì„ ì¶”ì¶œí•˜ê³  ë¶„ë¥˜ ì •ë³´ ìƒì„±
    4. JSON í˜•íƒœë¡œ êµ¬ì¡°í™”í•˜ì—¬ íŒŒì¼ë¡œ ì €ì¥
    
    JSON êµ¬ì¡°:
    {
        "id": ë¬¸ì œ ë²ˆí˜¸,
        "classification": ë¶„ë¥˜ ("start-end", "start-start", "end-end", "unknown"),
        "content": [ë¬¸ì œ ë‚´ìš©ì˜ ì¤„ë“¤],
        "page": í˜ì´ì§€ ë²ˆí˜¸
    }
    """
    input_file = Path("output/result.paged.filtered.mmd")
    
    # ì…ë ¥ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    if not input_file.exists():
        print(f"íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {input_file}")
        return
    
    print("\n=== ë¬¸ì œ ë¶„í•  ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ ì €ì¥ ===")
    
    # ì›ë³¸ ë¬¸ì„œë¥¼ ë‹¤ì‹œ ì½ì–´ì„œ ë¬¸ì œ ë‚´ìš© ì¶”ì¶œì„ ìœ„í•œ ì¤€ë¹„
    with open(input_file, 'r', encoding='utf-8', errors='ignore') as f:
        lines = f.readlines()
    
    # ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì¤„ ì •ë³´ë¥¼ ë‹¤ì‹œ ìˆ˜ì§‘ (í˜ì´ì§€ ì •ë³´ í¬í•¨)
    # ì´ëŠ” ê° ë¬¸ì œì˜ í˜ì´ì§€ ì •ë³´ë¥¼ ì •í™•íˆ íŒŒì•…í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤
    print("1ë‹¨ê³„: ì‹œì‘/ì¢…ë£Œ ì¤„ ì •ë³´ ì¬ìˆ˜ì§‘ (í˜ì´ì§€ ì •ë³´ í¬í•¨)")
    start_lines = []  # ì‹œì‘ ì¤„ ì •ë³´ (ì¤„ ë²ˆí˜¸ì™€ í˜ì´ì§€ ë²ˆí˜¸ í¬í•¨)
    end_lines = []    # ì¢…ë£Œ ì¤„ ì •ë³´ (ì¤„ ë²ˆí˜¸ì™€ í˜ì´ì§€ ë²ˆí˜¸ í¬í•¨)
    current_page = 1  # í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
    
    for i, line in enumerate(lines, 1):
        line = line.rstrip('\n')
        det = norm_for_detection(line)
        
        # í˜ì´ì§€ ë§ˆí¬ í™•ì¸ ë° í˜ì´ì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        page_match = PAGE_MARK.match(det)
        if page_match:
            current_page = int(page_match.group(1))
            continue
        
        # ë¬¸í•­ ì‹œì‘ ì‹ í˜¸ í™•ì¸
        if QUESTION_RX.match(det):
            start_lines.append({'line': i, 'page': current_page})
        
        # ë¬¸í•­ ì¢…ë£Œ ì‹ í˜¸ í™•ì¸ (ì´ë¯¸ì§€ ë§í¬ ì œì™¸)
        if QUESTION_END_RX.search(det) and not IMAGE_LINK_RX.search(det):
            # ì†Œë¬¸ì œ í˜•íƒœì˜ ì„ íƒì§€ëŠ” ì¢…ë£Œ ì‹ í˜¸ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
            if not (CHOICE_LINE_RX.match(det) and not QUESTION_RX.match(det)):
                # ì¢…ë£Œ ì‹ í˜¸ ë°œê²¬ ì‹œ, ì¶”ê°€ ì¡°ê±´ë“¤ì„ í™•ì¸í•˜ì—¬ ì‹¤ì œ ì¢…ë£Œ ì¤„ ì°¾ê¸°
                # start_signalsì™€ end_signalsë¥¼ ë¹ˆ ë¦¬ìŠ¤íŠ¸ë¡œ ì „ë‹¬ (ì´ ë‹¨ê³„ì—ì„œëŠ” ì•„ì§ ìˆ˜ì§‘ ì¤‘)
                actual_end_line = find_actual_end_line(lines, i, current_page, [], [])
                end_lines.append({'line': actual_end_line + 1, 'page': current_page})
    
    print(f"ìˆ˜ì§‘ ì™„ë£Œ: ì‹œì‘ì¤„ {len(start_lines)}ê°œ, ì¢…ë£Œì¤„ {len(end_lines)}ê°œ")
    
    # ê° ë¬¸ì œì˜ ë‚´ìš©ì„ ì¶”ì¶œí•˜ê³  JSON ë°ì´í„°ë¡œ ë³€í™˜
    print("2ë‹¨ê³„: ë¬¸ì œ ë‚´ìš© ì¶”ì¶œ ë° JSON ë°ì´í„° ìƒì„±")
    problems_data = []
    
    for i, (start_line, end_line) in enumerate(problems, 1):
        print(f"  ë¬¸ì œ {i} ì²˜ë¦¬ ì¤‘: ì¤„ {start_line}~{end_line}")
        
        # ë¬¸ì œ ë‚´ìš© ì¶”ì¶œ (1-based ì¸ë±ìŠ¤ë¥¼ 0-basedë¡œ ë³€í™˜í•˜ì—¬ ì¶”ì¶œ)
        problem_content = []
        for line_idx in range(start_line - 1, end_line):  # 0-based ì¸ë±ìŠ¤ë¡œ ë³€í™˜
            if 0 <= line_idx < len(lines):
                # ê° ì¤„ì˜ ê°œí–‰ ë¬¸ìë¥¼ ì œê±°í•˜ì—¬ ë‚´ìš©ë§Œ ì¶”ì¶œ
                problem_content.append(lines[line_idx].rstrip('\n'))
        
        # í˜ì´ì§€ ì •ë³´ ì°¾ê¸°
        # ì‹œì‘ ì¤„ì˜ í˜ì´ì§€ ì •ë³´ë¥¼ ì°¾ì•„ì„œ í•´ë‹¹ ë¬¸ì œì˜ í˜ì´ì§€ë¡œ ì„¤ì •
        problem_page = None
        for start_info in start_lines:
            if start_info['line'] == start_line:
                problem_page = start_info['page']
                break
        
        # ë¬¸í•­ ë¶„ë¥˜ ì‹ í˜¸ ê²°ì •
        # ë¬¸ì œì˜ ì‹œì‘ê³¼ ì¢…ë£Œê°€ ì–´ë–¤ ì‹ í˜¸ë¡œ ì´ë£¨ì–´ì¡ŒëŠ”ì§€ì— ë”°ë¼ ë¶„ë¥˜
        is_start_start = start_line in [s['line'] for s in start_lines]  # ì‹œì‘ì¤„ë¡œ ì‹œì‘í•˜ëŠ”ì§€
        is_start_end = end_line in [e['line'] for e in end_lines]        # ì¢…ë£Œì¤„ë¡œ ëë‚˜ëŠ”ì§€
        
        if is_start_start and is_start_end:
            classification = "start-end"    # ì‹œì‘ì¤„ë¡œ ì‹œì‘í•˜ê³  ì¢…ë£Œì¤„ë¡œ ëë‚¨
        elif is_start_start:
            classification = "start-start"  # ì‹œì‘ì¤„ë¡œ ì‹œì‘í•˜ê³  ì‹œì‘ì¤„ë¡œ ëë‚¨ (ë‹¤ìŒ ë¬¸ì œì™€ ì—°ê²°)
        elif is_start_end:
            classification = "end-end"      # ì¢…ë£Œì¤„ë¡œ ì‹œì‘í•˜ê³  ì¢…ë£Œì¤„ë¡œ ëë‚¨ (ì´ì „ ë¬¸ì œì™€ ì—°ê²°)
        else:
            classification = "unknown"      # ë¶„ë¥˜ ë¶ˆê°€ëŠ¥í•œ ê²½ìš°
        
        # ë¬¸ì œ ë°ì´í„°ë¥¼ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ êµ¬ì„±
        problem_data = {
            "id": i,                        # ë¬¸ì œ ë²ˆí˜¸ (1ë¶€í„° ì‹œì‘)
            "classification": classification, # ë¬¸ì œ ë¶„ë¥˜
            "content": problem_content,     # ë¬¸ì œ ë‚´ìš© (ì¤„ ë‹¨ìœ„ ë¦¬ìŠ¤íŠ¸)
            "page": problem_page           # í˜ì´ì§€ ë²ˆí˜¸
        }
        
        problems_data.append(problem_data)
        print(f"    ë¶„ë¥˜: {classification}, í˜ì´ì§€: {problem_page}, ë‚´ìš© ê¸¸ì´: {len(problem_content)}ì¤„")
    
    # JSON íŒŒì¼ë¡œ ì €ì¥
    print("3ë‹¨ê³„: JSON íŒŒì¼ë¡œ ì €ì¥")
    output_file = Path("output/problems.json")
    
    # ensure_ascii=Falseë¡œ í•œê¸€ì´ ìœ ë‹ˆì½”ë“œ ì´ìŠ¤ì¼€ì´í”„ë˜ì§€ ì•Šë„ë¡ ì„¤ì •
    # indent=2ë¡œ ê°€ë…ì„± ì¢‹ê²Œ ë“¤ì—¬ì“°ê¸° ì ìš©
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(problems_data, f, ensure_ascii=False, indent=2)
    
    print(f"\në¬¸ì œ ë¶„í•  ê²°ê³¼ê°€ {output_file}ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    print(f"ì´ {len(problems_data)}ê°œ ë¬¸ì œê°€ JSON íŒŒì¼ë¡œ ì €ì¥ë¨")
    
    # ì €ì¥ëœ íŒŒì¼ì˜ í¬ê¸° ì •ë³´ ì¶œë ¥
    file_size = output_file.stat().st_size
    print(f"íŒŒì¼ í¬ê¸°: {file_size:,} bytes ({file_size/1024:.1f} KB)")

# =============================================================================
# ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜ ì„¹ì…˜
# =============================================================================

def main():
    """
    split2.pyì˜ ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
    
    ì´ í•¨ìˆ˜ëŠ” ì „ì²´ ë¬¸ì œ ë¶„í•  í”„ë¡œì„¸ìŠ¤ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤:
    1. ì‹œì‘ ì¤„ ì°¾ê¸°
    2. ì¢…ë£Œ ì¤„ ì°¾ê¸°  
    3. ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•œ ë¬¸ì œ ë¶„í• 
    4. JSON íŒŒì¼ë¡œ ê²°ê³¼ ì €ì¥
    5. ê²°ê³¼ ìš”ì•½ ë° ìƒì„¸ ì •ë³´ ì¶œë ¥
    
    ì „ì²´ ì²˜ë¦¬ íë¦„:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ì‹œì‘ ì¤„ ì°¾ê¸°   â”‚â”€â”€â”€â–¶â”‚   ì¢…ë£Œ ì¤„ ì°¾ê¸°   â”‚â”€â”€â”€â–¶â”‚  ë¬¸ì œ ë¶„í•  ì•Œê³ ë¦¬ì¦˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                           â”‚
                                                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ê²°ê³¼ ìš”ì•½ ì¶œë ¥  â”‚â—€â”€â”€â”€â”‚  JSON íŒŒì¼ ì €ì¥  â”‚â—€â”€â”€â”€â”‚   ë¶„í• ëœ ë¬¸ì œë“¤   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    print("=" * 80)
    print("ì‹œì‘ ì¤„ê³¼ ì¢…ë£Œ ì¤„ì„ ë…ë¦½ì ìœ¼ë¡œ ì°¾ì•„ì„œ ë¬¸ì œë¥¼ ìë™ ë¶„í• í•˜ëŠ” í”„ë¡œê·¸ë¨")
    print("=" * 80)
    
    # 1ë‹¨ê³„: ì‹œì‘ ì¤„ ì°¾ê¸°
    print("\n[1ë‹¨ê³„] ë¬¸í•­ì˜ ì‹œì‘ ì¤„ë“¤ì„ ì°¾ëŠ” ì¤‘...")
    start_lines = find_start_lines()
    
    # 2ë‹¨ê³„: ì¢…ë£Œ ì¤„ ì°¾ê¸°
    print("\n[2ë‹¨ê³„] ë¬¸í•­ì˜ ì¢…ë£Œ ì¤„ë“¤ì„ ì°¾ëŠ” ì¤‘...")
    end_lines = find_end_lines()
    
    # 3ë‹¨ê³„: ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•œ ë¬¸ì œ ë¶„í• 
    print("\n[3ë‹¨ê³„] ìœ í•œ ìƒíƒœ ê¸°ê³„ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ì œë¥¼ ë¶„í• í•˜ëŠ” ì¤‘...")
    problems = calculate_problems_with_algorithm()
    
    # 4ë‹¨ê³„: JSON íŒŒì¼ë¡œ ê²°ê³¼ ì €ì¥
    if problems:
        print("\n[4ë‹¨ê³„] ë¶„í• ëœ ë¬¸ì œë“¤ì„ JSON íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” ì¤‘...")
        save_problems_to_json(problems)
    else:
        print("\n[4ë‹¨ê³„] ë¶„í• ëœ ë¬¸ì œê°€ ì—†ì–´ì„œ JSON íŒŒì¼ ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
    
    # 5ë‹¨ê³„: ê²°ê³¼ ìš”ì•½ ë° ìƒì„¸ ì •ë³´ ì¶œë ¥
    print("\n" + "=" * 80)
    print("ì²˜ë¦¬ ì™„ë£Œ - ê²°ê³¼ ìš”ì•½")
    print("=" * 80)
    print(f"ğŸ“Š í†µê³„ ì •ë³´:")
    print(f"   â€¢ ì‹œì‘ ì¤„: {len(start_lines)}ê°œ")
    print(f"   â€¢ ì¢…ë£Œ ì¤„: {len(end_lines)}ê°œ")
    print(f"   â€¢ ë¶„í• ëœ ë¬¸ì œ: {len(problems)}ê°œ")
    
    # ì‹œì‘ ì¤„ ìƒì„¸ ì •ë³´ ì¶œë ¥
    if start_lines:
        print(f"\nğŸ“ ì‹œì‘ ì¤„ ìƒì„¸ ì •ë³´ ({len(start_lines)}ê°œ):")
        for i, item in enumerate(start_lines, 1):
            print(f"   {i:2d}. í˜ì´ì§€ {item['page']:2d}, ì¤„ {item['line']:3d}: {item['content']}")
    else:
        print("\nâš ï¸  ì‹œì‘ ì¤„ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    
    # ì¢…ë£Œ ì¤„ ìƒì„¸ ì •ë³´ ì¶œë ¥
    if end_lines:
        print(f"\nğŸ ì¢…ë£Œ ì¤„ ìƒì„¸ ì •ë³´ ({len(end_lines)}ê°œ):")
        for i, item in enumerate(end_lines, 1):
            print(f"   {i:2d}. í˜ì´ì§€ {item['page']:2d}, ì¤„ {item['line']:3d} (ì‹ í˜¸: {item['signal_line']:3d}): {item['content']}")
    else:
        print("\nâš ï¸  ì¢…ë£Œ ì¤„ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    
    # ë¶„í• ëœ ë¬¸ì œ ìƒì„¸ ì •ë³´ ì¶œë ¥
    if problems:
        print(f"\nğŸ“š ë¶„í• ëœ ë¬¸ì œ ìƒì„¸ ì •ë³´ ({len(problems)}ê°œ):")
        for i, (start, end) in enumerate(problems, 1):
            print(f"   ë¬¸ì œ {i:2d}: ì¤„ {start:3d}~{end:3d} (ì´ {end-start+1:2d}ì¤„)")
    else:
        print("\nâš ï¸  ë¶„í• ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    # ìµœì¢… ìƒíƒœ ì¶œë ¥
    print("\n" + "=" * 80)
    if problems:
        print("âœ… ë¬¸ì œ ë¶„í• ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        print(f"   ê²°ê³¼ íŒŒì¼: output/problems.json")
        print(f"   ì´ {len(problems)}ê°œì˜ ë¬¸ì œê°€ ë¶„í• ë˜ì–´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    else:
        print("âŒ ë¬¸ì œ ë¶„í• ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        print("   ì‹œì‘ ì¤„ì´ë‚˜ ì¢…ë£Œ ì¤„ì´ ì œëŒ€ë¡œ ê°ì§€ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    print("=" * 80)

# =============================================================================
# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì§„ì…ì 
# =============================================================================

if __name__ == "__main__":
    """
    ìŠ¤í¬ë¦½íŠ¸ê°€ ì§ì ‘ ì‹¤í–‰ë  ë•Œë§Œ main() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
    
    ì´ëŠ” ì´ íŒŒì¼ì´ ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ importë  ë•ŒëŠ” main()ì´ ì‹¤í–‰ë˜ì§€ ì•Šê³ ,
    ì§ì ‘ ì‹¤í–‰í•  ë•Œë§Œ ì‹¤í–‰ë˜ë„ë¡ í•˜ëŠ” Pythonì˜ í‘œì¤€ ê´€ë¡€ì…ë‹ˆë‹¤.
    """
    main()
